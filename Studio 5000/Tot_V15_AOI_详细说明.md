# Tot_V15 AOI 详细说明文档

## 目录😊

1. [概述](#概述)
2. [功能特性](#功能特性)
3. [系统架构](#系统架构)
4. [参数说明](#参数说明)
5. [核心逻辑详解](#核心逻辑详解)
6. [使用示例](#使用示例)
7. [配置指南](#配置指南)
8. [故障排查](#故障排查)
9. [维护建议](#维护建议)

---

## 概述

###  基本信息

- **AOI 名称**: Tot_V15
- **版本**: 1.2
- **类型**: Add-On Instruction (AOI)
- **编程语言**: Structured Text (ST)
- **适用平台**: Rockwell Automation Studio 5000
- **控制器系列**: ControlLogix / CompactLogix
- **软件版本**: Studio 5000 v33.00 及以上

###  功能定位

Tot_V15 是一个**多维度产量累计统计系统**，用于工业生产过程中的产量数据采集和统计。该系统支持多种时间维度的累计计数，能够自动进行班次切换、日期切换和月份切换，为生产管理提供准确的产量数据。

###  应用场景

- **制造业**: 生产线产量统计
- **矿业**: 矿石开采量统计
- **包装行业**: 产品包装数量统计
- **物流行业**: 货物处理量统计
- **任何需要产量统计的工业场景**

---

## 功能特性

###  多维度累计

| 累计维度 | 说明 | 典型应用 |
|---------|------|--------|
| **总累计** | 从系统启动开始的累计值，不自动清零 | 设备总生产量统计 |
| **分钟累计** | 每 n 分钟的累计值，可配置 | 即时产量监控、产量趋势分析 |
| **班累计** | 白班/夜班的累计值，自动切换 | 班组产量考核、班次对比 |
| **天累计** | 每天的累计值，00:00 切换 | 日产量报表、生产日报 |
| **月累计** | 每月的累计值，月初切换 | 月产量报表、生产月报 |

###  核心特性

1. **实时累计与历史累计分离**
   - 实时累计值（`_RT` 后缀）随时间变化，用于实时显示
   - 历史累计值在切换时刻冻结保存，用于数据查询

2. **自动切换**
   - 根据系统时间自动判断当前时间段
   - 自动切换累计维度，无需人工干预

3. **数据持久化**
   - 历史累计值在切换时刻保存，不会丢失
   - 支持掉电保持（需在控制器中配置）

4. **高度可配置**
   - 班次切换时间可配置
   - 累计周期可配置
   - 缩放系数可配置

5. **HMI 交互**
   - 支持 HMI 实时显示所有累计值
   - 支持 HMI 手动清除累计值
   - 提供标准的数据接口

6. **可靠性设计**
   - 脉冲上升沿检测，防止重复计数
   - 运行状态判断，确保只有在设备运行时才计数
   - 延迟清零机制，确保数据保存完整

---

## 系统架构

###  整体架构

```text
┌─────────────────────────────────────────────────────────────┐
│                    Tot_V15 AOI                             │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  输入参数   │  │  输出参数   │  │  输入输出   │         │
│  │  (Inputs)   │  │  (Outputs)  │  │  (InOut)    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│         │                │                │                │
│         ▼                ▼                ▼                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              核心逻辑处理单元                        │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │   │
│  │  │脉冲检测 │ │时间处理 │ │累计计数 │ │数据同步 │   │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
│         │                │                │                │
│         ▼                ▼                ▼                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  本地标签   │  │   定时器    │  │   HMI_CMD   │         │
│  │  (LocalTags)│  │  (TONR)     │  │  (数据块)   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

###  数据流向

```text
输入信号
  │
  ├─ In_Pulse (脉冲输入)
  │   └─ 上升沿检测 (OSRI)
  │       └─ 累计计数
  │           ├─ 总累计 (Out_Tot)
  │           ├─ 分钟累计 (Out_Tot_Min)
  │           ├─ 班累计 (Out_Tot_Class1/2)
  │           ├─ 天累计 (Out_Tot_D)
  │           └─ 月累计 (Out_Tot_M)
  │
  ├─ In_Run (运行状态)
  │   └─ 使能控制
  │       ├─ 允许累计计数
  │       └─ 定时器使能
  │
  ├─ 时间输入 (Year/Month/Day/Hour/Minute/Second)
  │   └─ 时间判断
  │       ├─ 班次切换判断
  │       ├─ 日期切换判断
  │       └─ 月份切换判断
  │
  └─ 配置参数 (In_Class1_Time, In_Tot_Min 等)
      └─ 累计周期配置

输出数据
  ├─ 实时累计值 (Out_Tot_*_RT)
  │   └─ HMI 实时显示
  │
  ├─ 历史累计值 (Out_Tot_*)
  │   └─ 数据查询、报表生成
  │
  └─ HMI_CMD (数据块)
      └─ HMI 数据交互
```

###  核心组件

####  脉冲检测单元

- **功能**: 检测输入脉冲的上升沿
- **实现**: 使用 OSRI (One Shot Rising Input) 指令
- **作用**: 确保每个脉冲只计数一次，防止重复计数

####  时间处理单元

- **功能**: 读取系统时间，计算时间偏移量
- **实现**: 时间数组 + 分钟偏移量计算
- **作用**: 为时间段判断提供数据支持

####  累计计数单元

- **功能**: 根据不同时间维度进行累计计数
- **实现**: IF 条件判断 + 累加操作
- **作用**: 实现多维度的累计统计

####  数据同步单元

- **功能**: 将累计值同步到 HMI 数据块
- **实现**: 数据复制操作
- **作用**: 实现 PLC 与 HMI 之间的数据交互

---

## 参数说明

###  输入参数 (Inputs)
| 参数名称 | 数据类型 | 默认值 | 说明 | 典型值 |
|---------|---------|-------|------|--------|
| **EnableIn** | BOOL | - | AOI 启用输入 | 1 (启用) |
| **In_Pulse** | BOOL | 0 | 脉冲输入 (上升沿触发) | 来自传感器 |
| **In_Run** | BOOL | 0 | 设备运行状态 | 1 (运行) |
| **In_Scale** | DINT | 0 | 缩放系数 (每脉冲产量) | 10 (每10脉冲=1件) |
| **Year** | DINT | 0 | 年份 | 2024 |
| **Month** | DINT | 0 | 月份 (1-12) | 1-12 |
| **Day** | DINT | 0 | 日期 (1-31) | 1-31 |
| **Hour** | DINT | 0 | 小时 (0-23) | 0-23 |
| **Minute** | DINT | 0 | 分钟 (0-59) | 0-59 |
| **Second** | DINT | 0 | 秒 (0-59) | 0-59 |
| **In_Tot_Min** | DINT | 0 | 分钟累计周期 (分钟) | 5 (每5分钟) |
| **In_Class1_Time_Hour** | DINT | 0 | 白班开始小时 | 8 (08:00) |
| **In_Class1_Time_Minute** | DINT | 0 | 白班开始分钟 | 0 (08:00) |
| **In_Class2_Time_Hour** | DINT | 0 | 夜班开始小时 | 20 (20:00) |
| **In_Class2_Time_Minute** | DINT | 0 | 夜班开始分钟 | 0 (20:00) |
| **In_Day_Time_Hour** | DINT | 0 | 天切换小时 | 0 (00:00) |
| **In_Day_Time_Minute** | DINT | 0 | 天切换分钟 | 0 (00:00) |

###  输出参数 (Outputs)

| 参数名称 | 数据类型 | 说明 | 用途 |
|---------|---------|------|------|
| **EnableOut** | BOOL | AOI 启用状态输出 | 指示 AOI 是否正在执行 |
| **Out_Tot** | REAL | 总累计值 | 设备总生产量 |
| **Out_Tot_Min** | REAL | 分钟累计值 | 即时产量监控 |
| **Out_Tot_Class_RT** | REAL | 班实时累计值 | 当前班次产量 |
| **Out_Tot_D_RT** | REAL | 天实时累计值 | 当日产量 |
| **Out_Tot_M_RT** | REAL | 月实时累计值 | 当月产量 |
| **Out_Tot_D** | REAL | 昨天累计值 | 昨日产量查询 |
| **Out_Tot_M** | REAL | 上个月累计值 | 上月产量查询 |
| **Out_Tot_Class1** | REAL | 白班累计值 | 白班产量查询 |
| **Out_Tot_Class2** | REAL | 夜班累计值 | 夜班产量查询 |

###  输入输出参数 (InOut)

| 参数名称 | 数据类型 | 说明 |
|---------|---------|------|
| **HMI_CMD** | PB_Tot_V15 | HMI 命令数据块 |

#### PB_Tot_V15 数据结构

```
PB_Tot_V15
├─ Clear (BIT) - 清除命令
├─ Out_Tot (REAL) - 总累计
├─ Out_Tot_Min (REAL) - 分钟累计
├─ Out_Tot_Class_RT (REAL) - 班实时累计
├─ Out_Tot_Class1 (REAL) - 白班累计
├─ Out_Tot_Class2 (REAL) - 夜班累计
├─ Out_Tot_D (REAL) - 昨天累计
├─ Out_Tot_D_RT (REAL) - 天实时累计
├─ Out_Tot_M (REAL) - 上个月累计
└─ Out_Tot_M_RT (REAL) - 月实时累计
```

###  本地标签 (Local Tags)

| 标签名称 | 数据类型 | 说明 | 用途 |
|---------|---------|------|------|
| **Current_Shift** | SINT | 当前班次标识 | 1=白班, 2=夜班 |
| **Shift_Change_Flag** | BOOL | 班次切换标志 | 指示是否发生班次切换 |
| **Day_Change_Flag** | BOOL | 日期切换标志 | 指示是否发生日期切换 |
| **Temp[32]** | REAL[32] | 临时累计数组 | 存储各维度的临时累计值 |
| **TONR_01** | FBD_TIMER | 分钟累计定时器 | 实现 n 分钟累计 |
| **OSRI_Pulse** | FBD_ONESHOT | 脉冲上升沿检测器 | 检测脉冲上升沿 |
| **Time[8]** | DINT[8] | 时间数组 | 存储系统时间 |
| **Out_Tot_Class1_RT** | REAL | 白班实时累计 | 白班实时产量 |
| **Out_Tot_Class2_RT** | REAL | 夜班实时累计 | 夜班实时产量 |
| **Time_Set1** | DINT | 白班开始时间偏移 | 班次切换判断 |
| **Time_Set2** | DINT | 夜班开始时间偏移 | 班次切换判断 |
| **Time_Set3_Day** | DINT | 天切换时间偏移 | 日期切换判断 |
| **Time_Real** | DINT | 当前时间偏移 | 时间段判断 |
| **Is_Leap_Year** | BOOL | 闰年标志 | 2月天数判断 |
| **Days_In_Month** | DINT | 当月天数 | 月份累计判断 |

---

## 核心逻辑详解

###  脉冲检测与总累计

####  工作原理

```
输入脉冲 (In_Pulse)
    │
    ▼
┌──────────────┐
│  OSRI 检测   │ ── 检测上升沿
└──────────────┘
    │
    ▼
┌──────────────┐
│  运行状态判断│ ── In_Run = 1?
└──────────────┘
    │ (是)
    ▼
┌──────────────┐
│  累计计数    │ ── Out_Tot += In_Scale
└──────────────┘
```

####  关键代码

```st
// 脉冲上升沿检测
OSRI_Pulse.InputBit := In_Pulse;
OSRI(OSRI_Pulse);

// 总累计计数
IF OSRI_Pulse.OutputBit AND In_Run THEN
    Out_Tot := Out_Tot + In_Scale;
    Temp[0] := Temp[0] + In_Scale;
END_IF;
```

####  设计要点

1. **上升沿检测**: 使用 OSRI 指令确保每个脉冲只计数一次
2. **运行状态判断**: 只有在设备运行时才计数，确保数据准确性
3. **缩放系数**: 支持脉冲数到实际产量的转换

###  分钟累计

####  工作原理

```
定时器配置
    │
    ├─ PRE = In_Tot_Min * 60000 (预设值，毫秒)
    ├─ Reset = DN (完成时自动复位)
    └─ TimerEnable = In_Run (运行时计时)
    │
    ▼
┌──────────────┐
│  TONR 定时器 │ ── 计时
└──────────────┘
    │
    ▼ (计时完成)
┌──────────────┐
│  更新累计值  │ ── Out_Tot_Min := Temp[0]
└──────────────┘
    │
    ▼
┌──────────────┐
│  清零临时值  │ ── Temp[0] := 0
└──────────────┘
```

####  关键代码

```st
// 定时器配置
TONR_01.PRE := In_Tot_Min * 60000;
TONR_01.Reset := TONR_01.DN;
TONR_01.TimerEnable := In_Run;
TONR(TONR_01);

// 计时完成处理
IF TONR_01.DN THEN
    Out_Tot_Min := Temp[0];
    Temp[0] := 0;
END_IF;
```

####  设计要点

1. **TONR 定时器**: 可保持型通电延时定时器
2. **自动复位**: 计时完成后自动复位，开始下一个周期
3. **运行使能**: 仅在设备运行时计时，确保累计准确性

###  班累计（白班/夜班）

####  工作原理

```
系统时间
    │
    ▼
┌──────────────┐
│ 计算时间偏移 │ ── Time_Real = Hour*60 + Minute
└──────────────┘
    │
    ▼
┌──────────────┐
│ 时间段判断   │ ── 白班? 夜班?
└──────────────┘
    │
    ├─ 白班 (Time_Set1 <= Time_Real < Time_Set2)
    │   └─ 累计到 Temp[10]
    │
    └─ 夜班 (Time_Real >= Time_Set2 OR Time_Real < Time_Set1)
        └─ 累计到 Temp[11]
```

####  切换逻辑

| 时间点 | 操作 | 说明 |
|-------|------|------|
| 切换时刻 0-1 秒 | 保存累计值 | 将临时累计值保存到历史累计值 |
| 切换时刻 2-3 秒 | 清零临时值 | 清零临时累计变量，准备下一个周期 |

####  关键代码

```st
// 白班累计
IF (Time_Real >= Time_Set1) AND (Time_Real < Time_Set2) AND OSRI_Pulse.OutputBit AND In_Run THEN
    Temp[10] := Temp[10] + In_Scale;
END_IF;

// 白班结束保存
IF (Hour = In_Class2_Time_Hour) AND (Minute = In_Class2_Time_Minute) AND (Second <= 1) THEN
    Out_Tot_Class1 := Temp[10];
    Out_Tot_Class1_RT := 0;
END_IF;

// 白班结束清零
IF (Hour = In_Class2_Time_Hour) AND (Minute = In_Class2_Time_Minute) AND (Second >= 2) AND (Second <= 3) THEN
    Temp[10] := 0;
END_IF;
```

####  设计要点

1. **时间段判断**: 使用分钟偏移量进行比较，逻辑清晰
2. **夜班跨天**: 使用 OR 条件处理夜班跨 midnight 的情况
3. **延迟清零**: 延迟 2 秒清零确保数据保存完整

###  天累计

####  工作原理

```
脉冲输入
    │
    ▼
┌──────────────┐
│  累计计数    │ ── Temp[8] += In_Scale
└──────────────┘
    │
    ▼
┌──────────────┐
│ 实时累计更新 │ ── Out_Tot_D_RT := Temp[8]
└──────────────┘
    │
    ▼ (到达切换时间)
┌──────────────┐
│ 保存累计值   │ ── Out_Tot_D := Temp[8]
└──────────────┘
    │
    ▼ (延迟 2 秒)
┌──────────────┐
│ 清零临时值   │ ── Temp[8] := 0
└──────────────┘
```

####  关键代码

```st
// 天累计计数
IF OSRI_Pulse.OutputBit AND In_Run THEN
    Temp[8] := Temp[8] + In_Scale;
END_IF;

// 实时累计更新
Out_Tot_D_RT := Temp[8];

// 天结束处理
IF (Hour = In_Day_Time_Hour) AND (Minute = In_Day_Time_Minute) AND (Second <= 1) THEN
    Out_Tot_D := Temp[8];
    Out_Tot_D_RT := 0;
END_IF;

IF (Hour = In_Day_Time_Hour) AND (Minute = In_Day_Time_Minute) AND (Second >= 2) AND (Second <= 3) THEN
    Temp[8] := 0;
END_IF;
```

###  月累计

####  工作原理

```
系统时间
    │
    ▼
┌──────────────┐
│ 闰年判断     │ ── Is_Leap_Year = (Year MOD 4 = 0) AND ...
└──────────────┘
    │
    ▼
┌──────────────┐
│ 月份天数计算 │ ── CASE Month OF ...
└──────────────┘
    │
    ▼
┌──────────────┐
│ 有效日期判断 │ ── Day >= 1 AND Day <= Days_In_Month
└──────────────┘
    │
    ▼
┌──────────────┐
│ 累计计数     │ ── Temp[4] += In_Scale
└──────────────┘
```

####  月份天数规则

| 月份 | 天数 | 说明 |
|-----|------|------|
| 1, 3, 5, 7, 8, 10, 12 | 31 天 | 大月 |
| 4, 6, 9, 11 | 30 天 | 小月 |
| 2 | 28 天 | 平年 |
| 2 | 29 天 | 闰年 |

####  闰年规则

```
闰年条件 = (能被 4 整除 且 不能被 100 整除) 或 (能被 400 整除)

示例:
- 2000 年: 2000 MOD 400 = 0 → 闰年
- 2004 年: 2004 MOD 4 = 0 且 2004 MOD 100 ≠ 0 → 闰年
- 1900 年: 1900 MOD 4 = 0 但 1900 MOD 100 = 0 → 平年
- 2024 年: 2024 MOD 4 = 0 且 2024 MOD 100 ≠ 0 → 闰年
```

####  关键代码

```st
// 闰年判断
Is_Leap_Year := (Year MOD 4 = 0) AND (Year MOD 100 <> 0) OR (Year MOD 400 = 0);

// 月份天数计算
CASE Month OF
    1, 3, 5, 7, 8, 10, 12: Days_In_Month := 31;
    4, 6, 9, 11: Days_In_Month := 30;
    2:
        IF Is_Leap_Year THEN
            Days_In_Month := 29;
        ELSE
            Days_In_Month := 28;
        END_IF;
END_CASE;

// 月累计计数
IF (Day >= 1) AND (Day <= Days_In_Month) AND OSRI_Pulse.OutputBit AND In_Run THEN
    Temp[4] := Temp[4] + In_Scale;
END_IF;
```

####  设计要点

1. **CASE 语句**: 使用 CASE 替代复杂的 IF 嵌套，提高可读性
2. **闰年处理**: 准确的闰年判断逻辑
3. **有效日期判断**: 确保只在当月有效日期内累计

###  HMI 命令处理

####  清除命令处理

```st
IF HMI_CMD.Clear THEN
    // 清零所有累计值
    Out_Tot := 0;
    Out_Tot_Min := 0;
    // ... 其他累计值清零
    
    // 清零临时变量
    Temp[0] := 0;
    Temp[4] := 0;
    // ... 其他临时变量清零
    
    // 清除命令位
    HMI_CMD.Clear := 0;
END_IF;
```

####  数据同步

```st
// 将累计值同步到 HMI 数据块
HMI_CMD.Out_Tot := Out_Tot;
HMI_CMD.Out_Tot_Min := Out_Tot_Min;
HMI_CMD.Out_Tot_Class_RT := Out_Tot_Class_RT;
// ... 其他累计值同步
```

---

## 使用示例

###  基本使用

####  在梯形图中调用

```
┌────────────────────────────────────────┐
│         Tot_V15 (AOI 调用)             │
├────────────────────────────────────────┤
│ EnableIn:    ───────┤ 1 (启用)        │
│ In_Pulse:    ───────┤ I:1/0 (脉冲输入)│
│ In_Run:      ───────┤ I:1/1 (运行信号)│
│ In_Scale:    ───────┤ 10 (缩放系数)   │
│ Year:        ───────┤ Local:Year      │
│ Month:       ───────┤ Local:Month     │
│ Day:         ───────┤ Local:Day       │
│ Hour:        ───────┤ Local:Hour      │
│ Minute:      ───────┤ Local:Minute    │
│ Second:      ───────┤ Local:Second    │
│ In_Tot_Min:  ───────┤ 5 (5分钟累计)   │
│ In_Class1_Time_Hour: ──┤ 8 (白班8点)  │
│ In_Class2_Time_Hour: ──┤ 20 (夜班20点)│
│ ... 其他配置参数                       │
├────────────────────────────────────────┤
│ EnableOut:   ───────┤ O:1/0           │
│ Out_Tot:     ───────┤ D100 (总累计)   │
│ Out_Tot_Min: ───────┤ D101 (分钟累计) │
│ Out_Tot_Class_RT: ──┤ D102 (班实时)   │
│ Out_Tot_D_RT: ──────┤ D103 (天实时)   │
│ Out_Tot_M_RT: ──────┤ D104 (月实时)   │
│ Out_Tot_D:   ───────┤ D105 (昨天)     │
│ Out_Tot_M:   ───────┤ D106 (上个月)   │
│ HMI_CMD:     ───────┤ D200 (数据块)   │
└────────────────────────────────────────┘
```

####  典型配置示例

**场景**: 某生产线需要统计产量，每 10 个脉冲代表 1 件产品，白班 08:00-20:00，夜班 20:00-08:00

```
配置参数:
├─ In_Scale: 10 (每10脉冲=1件)
├─ In_Tot_Min: 5 (每5分钟累计)
├─ In_Class1_Time_Hour: 8 (白班8点开始)
├─ In_Class1_Time_Minute: 0
├─ In_Class2_Time_Hour: 20 (夜班20点开始)
├─ In_Class2_Time_Minute: 0
├─ In_Day_Time_Hour: 0 (00:00切换)
└─ In_Day_Time_Minute: 0

运行结果:
├─ Out_Tot: 总生产量 (件)
├─ Out_Tot_Min: 每5分钟产量 (件)
├─ Out_Tot_Class_RT: 当前班次产量 (件)
├─ Out_Tot_D_RT: 当日产量 (件)
├─ Out_Tot_M_RT: 当月产量 (件)
├─ Out_Tot_D: 昨日产量 (件)
├─ Out_Tot_M: 上月产量 (件)
├─ Out_Tot_Class1: 白班产量 (件)
└─ Out_Tot_Class2: 夜班产量 (件)
```

###  HMI 集成

####  数据显示

```
HMI 画面设计:

┌─────────────────────────────────────────┐
│           产量统计系统                  │
├─────────────────────────────────────────┤
│ 总累计:     [Out_Tot]          件       │
│ 班实时:     [Out_Tot_Class_RT] 件       │
│ 天实时:     [Out_Tot_D_RT]     件       │
│ 月实时:     [Out_Tot_M_RT]     件       │
├─────────────────────────────────────────┤
│ 白班产量:   [Out_Tot_Class1]   件       │
│ 夜班产量:   [Out_Tot_Class2]   件       │
│ 昨日产量:   [Out_Tot_D]        件       │
│ 上月产量:   [Out_Tot_M]        件       │
├─────────────────────────────────────────┤
│              [清除按钮]                 │
│         (HMI_CMD.Clear = 1)            │
└─────────────────────────────────────────┘
```

####  清除操作流程

```
HMI 操作
    │
    ▼
┌──────────────┐
│ 点击清除按钮 │
└──────────────┘
    │
    ▼
┌──────────────┐
│ HMI_CMD.Clear│ ── 设置为 1
└──────────────┘
    │
    ▼
┌──────────────┐
│ PLC 扫描执行 │ ── 检测到 Clear = 1
└──────────────┘
    │
    ▼
┌──────────────┐
│ 清零所有累计 │ ── 执行清除逻辑
└──────────────┘
    │
    ▼
┌──────────────┐
│ 清除命令位   │ ── HMI_CMD.Clear := 0
└──────────────┘
```

###  数据采集与报表

####  数据采集

```
// 在 PLC 中创建数据采集逻辑
// 每天 00:05 保存前日产量到历史数据区

IF (Hour = 0) AND (Minute = 5) AND (Second = 0) THEN
    // 保存前日产量
    HistoryData[DayIndex].Date := Local:Date;
    HistoryData[DayIndex].Total := Out_Tot_D;
    HistoryData[DayIndex].Class1 := Out_Tot_Class1;
    HistoryData[DayIndex].Class2 := Out_Tot_Class2;
    
    // 索引递增
    DayIndex := DayIndex + 1;
    IF DayIndex > 365 THEN
        DayIndex := 1;
    END_IF;
END_IF;
```

####  报表生成

```
月产量报表示例:

┌─────────────────────────────────────────┐
│           2024 年 1 月产量报表          │
├─────────────────────────────────────────┤
│ 日期      │ 白班产量 │ 夜班产量 │ 合计  │
├──────────┼──────────┼──────────┼───────┤
│ 2024-01-01│ 1,250    │ 1,180    │ 2,430 │
│ 2024-01-02│ 1,320    │ 1,250    │ 2,570 │
│ 2024-01-03│ 1,280    │ 1,310    │ 2,590 │
│ ...       │ ...      │ ...      │ ...   │
├──────────┴──────────┴──────────┴───────┤
│ 月总计:                              78,540 │
└─────────────────────────────────────────┘
```

---

## 配置指南

###  快速配置步骤

#### 步骤 1: 导入 AOI

1. 在 Studio 5000 中打开项目
2. 右键点击 **Add-On Instructions**
3. 选择 **Import Add-On Instruction**
4. 选择 `Tot_V15_AOI.L5X` 文件
5. 点击 **Import** 完成导入

#### 步骤 2: 创建实例

1. 在梯形图中选择 **Add Instruction**
2. 在 **Add-On Instructions** 中找到 `Tot_V15`
3. 拖拽到梯级中
4. 输入实例名称（如 `Line1_Tot`）

#### 步骤 3: 配置输入参数

| 参数 | 配置建议 | 说明 |
|-----|---------|------|
| **EnableIn** | 1 | 启用 AOI |
| **In_Pulse** | 连接到脉冲传感器 | 产品检测信号 |
| **In_Run** | 连接到设备运行信号 | 确保只有运行时才计数 |
| **In_Scale** | 根据实际情况设置 | 每脉冲产量 |
| **Year/Month/Day/Hour/Minute/Second** | 连接到系统时间 | 使用 Controller 标签 |
| **In_Tot_Min** | 5 或 10 | 分钟累计周期 |
| **In_Class1_Time_Hour** | 8 | 白班开始小时 |
| **In_Class1_Time_Minute** | 0 | 白班开始分钟 |
| **In_Class2_Time_Hour** | 20 | 夜班开始小时 |
| **In_Class2_Time_Minute** | 0 | 夜班开始分钟 |
| **In_Day_Time_Hour** | 0 | 天切换小时 |
| **In_Day_Time_Minute** | 0 | 天切换分钟 |

#### 步骤 4: 配置输出参数

| 参数 | 配置建议 | 说明 |
|-----|---------|------|
| **EnableOut** | 连接到内部标签 | AOI 状态指示 |
| **Out_Tot/Out_Tot_Min/...** | 创建内部标签 | 累计值存储 |
| **HMI_CMD** | 创建 PB_Tot_V15 类型标签 | HMI 数据交互 |

#### 步骤 5: 配置掉电保持

1. 在 Controller Organizer 中右键点击 **Tags**
2. 选择 **Properties**
3. 选择 **Retentive** 标签
4. 添加需要掉电保持的标签:
   - `Out_Tot` (总累计)
   - `Out_Tot_D` (昨天累计)
   - `Out_Tot_M` (上个月累计)
   - `Out_Tot_Class1` (白班累计)
   - `Out_Tot_Class2` (夜班累计)
   - `Temp[*]` (临时累计数组)

#### 步骤 6: 下载到控制器

1. 点击 **Download** 按钮
2. 选择控制器
3. 确认下载
4. 验证运行状态

###  典型配置方案

#### 方案 1: 标准两班制

```
配置:
├─ 白班: 08:00 - 20:00
│  ├─ In_Class1_Time_Hour: 8
│  └─ In_Class1_Time_Minute: 0
│
├─ 夜班: 20:00 - 08:00
│  ├─ In_Class2_Time_Hour: 20
│  └─ In_Class2_Time_Minute: 0
│
├─ 天切换: 00:00
│  ├─ In_Day_Time_Hour: 0
│  └─ In_Day_Time_Minute: 0
│
└─ 分钟累计: 每 5 分钟
   └─ In_Tot_Min: 5
```

#### 方案 2: 三班制（需要修改 AOI）

```
说明: 标准 AOI 只支持两班制
如需三班制，需要:
1. 添加第三个班次的配置参数
2. 修改时间段判断逻辑
3. 添加第三个班次的累计变量

建议: 对于三班制，建议使用三个独立的 Tot_V15 实例
```

#### 方案 3: 无班次区分

```
配置:
├─ 白班: 00:00 - 24:00 (覆盖全天)
│  ├─ In_Class1_Time_Hour: 0
│  └─ In_Class1_Time_Minute: 0
│
├─ 夜班: 24:00 (不使用)
│  ├─ In_Class2_Time_Hour: 24
│  └─ In_Class2_Time_Minute: 0
│
说明: 这样配置后，班累计等于天累计
```

---

## 故障排查

###  常见问题

#### 问题 1: 累计值不增加

**症状**: Out_Tot 等累计值始终为 0

**可能原因**:
1. EnableIn = 0 (AOI 未启用)
2. In_Run = 0 (设备未运行)
3. In_Pulse 没有脉冲输入
4. In_Scale = 0 (缩放系数为 0)

**排查步骤**:

```
1. 检查 EnableIn
   └─ 应为 1
   
2. 检查 In_Run
   └─ 设备运行时应为 1
   
3. 检查 In_Pulse
   └─ 使用 Watch 监控，应有 0->1 的跳变
   
4. 检查 In_Scale
   └─ 应大于 0
   
5. 检查 OSRI_Pulse.OutputBit
   └─ 脉冲到来时应有短暂的 1
```

**解决方案**:
- 确保 EnableIn = 1
- 确保 In_Run 正确连接到设备运行信号
- 检查脉冲传感器接线和配置
- 设置正确的 In_Scale 值

---

#### 问题 2: 累计值跳变

**症状**: 累计值突然增加很多或减少

**可能原因**:
1. In_Pulse 有干扰信号
2. In_Run 信号不稳定
3. 系统时间跳变
4. 清除命令被误触发

**排查步骤**:

```
1. 监控 In_Pulse
   └─ 检查是否有异常脉冲
   
2. 监控 In_Run
   └─ 检查是否有频繁跳变
   
3. 检查系统时间
   └─ 确保时间正常运行，没有跳变
   
4. 检查 HMI_CMD.Clear
   └─ 确保没有误触发
```

**解决方案**:
- 在脉冲输入处添加滤波
- 检查 In_Run 信号接线，增加抗干扰措施
- 确保系统时间正确配置
- 在 HMI 清除按钮添加确认对话框

---

#### 问题 3: 班次切换异常

**症状**: 白班/夜班累计值不正确，切换时间不对

**可能原因**:
1. 班次时间配置错误
2. 系统时间不准确
3. 时间段判断逻辑错误

**排查步骤**:

```
1. 检查班次时间配置
   ├─ In_Class1_Time_Hour/Minute
   └─ In_Class2_Time_Hour/Minute
   
2. 检查系统时间
   ├─ Year/Month/Day/Hour/Minute/Second
   └─ 确保时间准确
   
3. 监控时间变量
   ├─ Time_Real (当前时间偏移)
   ├─ Time_Set1 (白班开始)
   └─ Time_Set2 (夜班开始)
   
4. 检查时间段判断
   └─ 确认当前处于哪个时间段
```

**解决方案**:
- 配置正确的班次切换时间
- 确保系统时间准确（使用 SNTP 同步）
- 检查时间段判断逻辑

---

#### 问题 4: 月累计错误

**症状**: 2 月累计值异常，或月末累计错误

**可能原因**:
1. 闰年判断错误
2. 月份天数计算错误
3. 系统日期错误

**排查步骤**:

```
1. 检查系统日期
   └─ Year/Month/Day 是否正确
   
2. 监控闰年标志
   └─ Is_Leap_Year 是否正确
   
3. 监控月份天数
   └─ Days_In_Month 是否正确
   
4. 测试特殊年份
   ├─ 2000 年 (闰年)
   ├─ 1900 年 (平年)
   └─ 2024 年 (闰年)
```

**解决方案**:
- 确保系统日期正确
- 检查闰年判断逻辑
- 验证月份天数计算

---

#### 问题 5: HMI 无法显示数据

**症状**: HMI 画面没有累计值显示

**可能原因**:
1. HMI_CMD 数据块未正确连接
2. 数据类型不匹配
3. 通讯故障

**排查步骤**:

```
1. 检查 HMI_CMD 连接
   └─ 确保正确连接到 PB_Tot_V15 类型标签
   
2. 检查数据类型
   └─ 确保 HMI 标签数据类型与 PLC 一致
   
3. 测试通讯
   └─ 使用 Studio 5000 的通讯诊断工具
   
4. 监控 HMI_CMD 数据
   └─ 确保数据正确同步
```

**解决方案**:
- 正确配置 HMI_CMD 连接
- 确保数据类型匹配
- 检查 PLC 与 HMI 之间的通讯

---

###  诊断工具

####  Studio 5000 监控

```
使用 Watch 窗口监控关键变量:

┌─────────────────────────────────────────┐
│ Watch 窗口配置                          │
├─────────────────────────────────────────┤
│ 变量名称               │ 当前值 │ 趋势  │
├────────────────────────┼────────┼───────┤
│ Line1_Tot.EnableIn     │ 1      │ 稳定  │
│ Line1_Tot.In_Pulse     │ 0/1    │ 跳变  │
│ Line1_Tot.In_Run       │ 1      │ 稳定  │
│ Line1_Tot.OSRI_Pulse.OutputBit │ 0    │ 脉冲 │
│ Line1_Tot.Out_Tot      │ 1250.0 │ 递增  │
│ Line1_Tot.Time_Real    │ 650    │ 递增  │
│ Line1_Tot.Time_Set1    │ 480    │ 稳定  │
│ Line1_Tot.Time_Set2    │ 1200   │ 稳定  │
└─────────────────────────────────────────┘
```

####  趋势图分析

```
使用 Trend 工具分析累计值趋势:

累计值趋势图
    │
    │    ╱╲    ╱╲    ╱╲    (班累计值)
    │   ╱  ╲  ╱  ╲  ╱  ╲
    │  ╱    ╲╱    ╲╱    ╲
    │ ╱      ╱      ╱      ╲
    │╱      ╱      ╱        ╲
    └─────────────────────────── 时间
     08:00 20:00 08:00 20:00
     (白班) (夜班) (白班) (夜班)

正常趋势: 每个班期间累计值平稳上升
异常趋势: 突然跳变、不增长、负增长
```

---

## 维护建议

###  日常维护

####  每日检查

| 检查项 | 检查内容 | 频率 |
|-------|---------|------|
| **累计值显示** | HMI 显示的累计值是否合理 | 每班 |
| **班次切换** | 白班/夜班切换是否正常 | 每班 |
| **天累计切换** | 00:00 时天累计是否正常切换 | 每日 |
| **脉冲输入** | 脉冲传感器工作是否正常 | 每班 |

####  每周检查

| 检查项 | 检查内容 | 频率 |
|-------|---------|------|
| **数据备份** | 导出累计值数据 | 每周 |
| **趋势分析** | 分析产量趋势是否正常 | 每周 |
| **对比分析** | 白班/夜班产量对比 | 每周 |

####  每月检查

| 检查项 | 检查内容 | 频率 |
|-------|---------|------|
| **月累计切换** | 月初累计值是否正常切换 | 每月 |
| **闰年处理** | 2 月累计值是否正确（闰年时） | 每年 2 月 |
| **数据归档** | 将月度数据归档到历史数据库 | 每月 |

###  数据备份

####  备份策略

```
备份频率:
├─ 每日: 备份当日累计值
├─ 每周: 备份本周累计值
├─ 每月: 备份本月累计值
└─ 每年: 备份本年累计值

备份内容:
├─ Out_Tot (总累计)
├─ Out_Tot_D (日累计历史)
├─ Out_Tot_M (月累计历史)
├─ Out_Tot_Class1/2 (班累计历史)
└─ 生产报表

备份方式:
├─ PLC 内部存储（使用配方功能）
├─ HMI 数据导出（CSV/Excel）
├─ 历史数据库（如 FactoryTalk Historian）
└─ 手动记录（纸质报表）
```

####  自动备份脚本

```st
// 每日 23:55 备份当日数据
IF (Hour = 23) AND (Minute = 55) AND (Second = 0) THEN
    // 备份到历史数据区
    DailyBackup[DayOfWeek].Date := CONCAT(CONCAT(STR(Year,4), '/'), CONCAT(STR(Month,2), CONCAT('/', STR(Day,2))));
    DailyBackup[DayOfWeek].Total := Out_Tot_D;
    DailyBackup[DayOfWeek].Class1 := Out_Tot_Class1;
    DailyBackup[DayOfWeek].Class2 := Out_Tot_Class2;
END_IF;
```

###  性能优化

####  扫描时间优化

```
当前扫描时间影响:
├─ AOI 执行时间: 约 1-2 ms
├─ 脉冲检测精度: 1 个扫描周期
└─ 累计值更新频率: 每个扫描周期

优化建议:
1. 合理设置任务周期
   ├─ 高速生产线: 10 ms
   ├─ 中速生产线: 50 ms
   └─ 低速生产线: 100 ms

2. 减少不必要的监控
   └─ 只监控关键变量

3. 使用高效的数据类型
   ├─ 累计值使用 REAL (足够精度)
   └─ 时间值使用 DINT (高效)
```

####  内存优化

```
内存使用分析:
├─ 输入参数: 约 50 字节
├─ 输出参数: 约 100 字节
├─ 本地标签: 约 500 字节
└─ 总计: 约 650 字节/实例

优化建议:
1. 合理使用掉电保持
   ├─ 只对需要保持的变量启用掉电保持
   └─ 减少掉电保持区使用

2. 优化 Temp 数组
   ├─ 只使用必要的数组元素
   └─ 避免浪费
```

###  版本升级

####  升级流程

```
升级步骤:

1. 准备工作
   ├─ 备份当前项目
   ├─ 阅读版本变更说明
   └─ 评估影响范围

2. 测试环境验证
   ├─ 在测试环境中导入新版本
   ├─ 配置相同参数
   ├─ 运行测试
   └─ 验证功能正常

3. 生产环境升级
   ├─ 停止生产
   ├─ 备份生产数据
   ├─ 导入新版本 AOI
   ├─ 更新实例配置
   ├─ 下载到控制器
   └─ 启动生产

4. 监控运行
   ├─ 观察累计值是否正常
   ├─ 检查班次切换
   └─ 验证数据准确性
```

####  版本兼容性

| 版本 | 兼容性 | 说明 |
|-----|-------|------|
| 1.0 → 1.1 | 兼容 | 仅添加注释，无功能变化 |
| 1.1 → 1.2 | 兼容 | 优化逻辑，参数不变 |
| 1.2 → 2.0 | 不兼容 | 可能有参数变化 |

---

## 附录

### 附录 A: 数据类型参考

| 数据类型 | 范围 | 精度 | 用途 |
|---------|------|------|------|
| **BOOL** | 0/1 | - | 逻辑判断 |
| **DINT** | -2,147,483,648 ~ 2,147,483,647 | 整数 | 时间值、计数值 |
| **REAL** | -3.4e38 ~ 3.4e38 | 约 6-7 位有效数字 | 累计值 |
| **SINT** | -128 ~ 127 | 整数 | 控制位存储 |

### 附录 B: 常用计算公式

#### 分钟偏移量计算

```
Time_Real = Hour * 60 + Minute

示例:
- 08:30 = 8 * 60 + 30 = 510 分钟
- 20:15 = 20 * 60 + 15 = 1215 分钟
- 00:00 = 0 * 60 + 0 = 0 分钟
```

#### 缩放系数计算

```
In_Scale = 每脉冲产量

示例:
- 每 1 个脉冲 = 1 件产品 → In_Scale = 1
- 每 10 个脉冲 = 1 件产品 → In_Scale = 10
- 每 1 个脉冲 = 0.5 件产品 → In_Scale = 0.5 (需使用 REAL 类型)
```

#### 产量计算

```
实际产量 = 累计值 / In_Scale

示例:
- Out_Tot = 1000, In_Scale = 10 → 实际产量 = 100 件
- Out_Tot = 500, In_Scale = 1 → 实际产量 = 500 件
```

### 附录 C: 术语表

| 术语 | 英文 | 说明 |
|-----|------|------|
| **AOI** | Add-On Instruction | 附加指令，可重用的程序模块 |
| **ST** | Structured Text | 结构化文本，PLC 编程语言 |
| **OSRI** | One Shot Rising Input | 上升沿检测指令 |
| **TONR** | Timer On-Delay Retentive | 可保持型通电延时定时器 |
| **HMI** | Human Machine Interface | 人机界面 |
| **RT** | Real-Time | 实时 |
| **PRE** | Preset | 预设值 |
| **ACC** | Accumulator | 累加值 |
| **DN** | Done | 完成位 |

---

## 联系方式

如有问题或建议，请联系:

- **技术支持**: 1334786501@qq.com
- **文档版本**: 1.0
- **最后更新**: 2026-01-21

---

**文档结束**
