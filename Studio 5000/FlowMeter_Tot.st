// ===============================================================
// AOI 名称: FlowMeter_Tot (流量计累计量统计)
// 版本: 1.0
// 编程语言: Structured Text (ST)
// 适用平台: Studio 5000 (ControlLogix/CompactLogix)
// ===============================================================
// 功能概述:
// 本程序实现一个多维度的流量计累计量统计系统,支持以下时间维度的累计:
// 1. 总累计 - 从系统启动开始的累计值
// 2. 白班累计 - 09:00 - 21:00 的累计值
// 3. 夜班累计 - 21:00 - 次日 09:00 的累计值
// 4. 3小时区间累计 - 每3小时的累计值
// ===============================================================
// 核心设计理念:
// 1. 实时累计与历史累计分离: 实时累计值随时间变化,历史累计值在切换时刻冻结
// 2. 自动切换: 根据系统时间自动判断当前时间段,切换累计维度
// 3. 数据持久化: 历史累计值在切换时刻保存,不会丢失
// 4. 可配置性: 班次时间、累计周期等参数可通过输入参数配置
// ===============================================================
// 变量命名规范:
// - 输入参数: In_xxx (如 In_Flow, In_Run)
// - 输出参数: Out_xxx (如 Out_Tot, Out_Tot_Class1)
// - 实时累计: xxx_RT (如 Out_Tot_Class_RT, Out_Tot_3H_RT)
// - 临时变量: Temp[索引] (如 Temp[0], Temp[1])
// - 时间设置: Time_Setxxx (如 Time_Set1, Time_Set2)
// ===============================================================

// ===============================================================
// 功能段 1: 流量检测与总累计
// 执行频率: 每次扫描
// 说明: 检测输入流量值的变化,并进行总累计计数
// ===============================================================
// 流量值处理
// 说明: 直接使用输入的流量累计值,无需上升沿检测
// 因为流量计通常直接输出累计值而非脉冲信号
IF In_Run THEN
    // 总累计值直接使用输入的流量累计值
    Out_Tot := In_Flow;
END_IF;

// ===============================================================
// 功能段 2: 时间数据准备
// 执行频率: 每次扫描
// 说明: 读取系统时间,计算时间偏移量和时间设置
// ===============================================================
// 读取系统时间到时间数组
// Time[0] = 年份 (如: 2024)
// Time[1] = 月份 (1-12)
// Time[2] = 日期 (1-31)
// Time[3] = 小时 (0-23)
// Time[4] = 分钟 (0-59)
// Time[5] = 秒 (0-59)
Time[0] := Year;
Time[1] := Month;
Time[2] := Day;
Time[3] := Hour;
Time[4] := Minute;
Time[5] := Second;

// 计算当前时间的分钟偏移量
// 公式: 小时 * 60 + 分钟
// 例如: 09:30 = 9 * 60 + 30 = 570 分钟
// 用途: 用于比较当前时间是否在某个时间段内
Time_Real := Hour * 60 + Minute;

// 计算班次切换时间的分钟偏移量
// Time_Set1: 白班开始时间 (09:00 = 540 分钟)
// Time_Set2: 夜班开始时间 (21:00 = 1260 分钟)
Time_Set1 := 9 * 60 + 0;  // 09:00
Time_Set2 := 21 * 60 + 0; // 21:00

// 计算3小时区间索引
// 0: 00:00-03:00, 1: 03:00-06:00, 2: 06:00-09:00
// 3: 09:00-12:00, 4: 12:00-15:00, 5: 15:00-18:00
// 6: 18:00-21:00, 7: 21:00-24:00
Hour_Index := Hour / 3;

// ===============================================================
// 功能段 3: 白班累计逻辑
// 执行频率: 每次扫描
// 说明: 在白班时间段内进行累计计数
// 时间段: 09:00 - 21:00
// ===============================================================
// 白班累计计数
// 条件:
// 1. 当前时间在白班时间段内 (Time_Real >= Time_Set1 AND Time_Real < Time_Set2)
// 2. 设备处于运行状态 (In_Run)
// 操作: 计算白班累计值
IF (Time_Real >= Time_Set1) AND (Time_Real < Time_Set2) AND In_Run THEN
    // 首次进入白班时,记录初始值
    IF NOT Flag_Class1_Start THEN
        Temp[10] := In_Flow;
        Flag_Class1_Start := TRUE;
        Flag_Class2_Start := FALSE;
    END_IF;
    
    // 计算白班实时累计值
    Out_Tot_Class1_RT := In_Flow - Temp[10];
END_IF;

// 白班结束处理 - 保存累计值
// 触发条件: 到达夜班开始时间 (21:00) 且在 0-1 秒内
IF (Hour = 21) AND (Minute = 0) AND (Second <= 1) AND In_Run THEN
    Out_Tot_Class1 := In_Flow - Temp[10];
    Out_Tot_Class1_RT := 0;
    Flag_Class1_Start := FALSE;
END_IF;

// ===============================================================
// 功能段 4: 夜班累计逻辑
// 执行频率: 每次扫描
// 说明: 在夜班时间段内进行累计计数
// 时间段: 21:00 - 次日 09:00
// ===============================================================
// 夜班累计计数
// 条件:
// 1. 当前时间在夜班时间段内 (Time_Real >= Time_Set2 OR Time_Real < Time_Set1)
// 2. 设备处于运行状态 (In_Run)
// 操作: 计算夜班累计值
IF ((Time_Real >= Time_Set2) OR (Time_Real < Time_Set1)) AND In_Run THEN
    // 首次进入夜班时,记录初始值
    IF NOT Flag_Class2_Start THEN
        Temp[11] := In_Flow;
        Flag_Class2_Start := TRUE;
        Flag_Class1_Start := FALSE;
    END_IF;
    
    // 计算夜班实时累计值
    Out_Tot_Class2_RT := In_Flow - Temp[11];
END_IF;

// 夜班结束处理 - 保存累计值
// 触发条件: 到达白班开始时间 (09:00) 且在 0-1 秒内
IF (Hour = 9) AND (Minute = 0) AND (Second <= 1) AND In_Run THEN
    Out_Tot_Class2 := In_Flow - Temp[11];
    Out_Tot_Class2_RT := 0;
    Flag_Class2_Start := FALSE;
END_IF;

// ===============================================================
// 功能段 5: 3小时区间累计逻辑
// 执行频率: 每次扫描
// 说明: 每3小时区间的累计计数
// 区间: 00:00-03:00, 03:00-06:00, 06:00-09:00, 09:00-12:00
//       12:00-15:00, 15:00-18:00, 18:00-21:00, 21:00-24:00
// ===============================================================
// 3小时区间累计计数
// 条件:
// 1. 设备处于运行状态 (In_Run)
// 操作: 计算当前3小时区间的累计值
IF In_Run THEN
    // 首次进入当前3小时区间时,记录初始值
    IF Last_Hour_Index <> Hour_Index THEN
        Temp[20 + Hour_Index] := In_Flow;
        Last_Hour_Index := Hour_Index;
    END_IF;
    
    // 计算当前3小时区间实时累计值
    Out_Tot_3H_RT := In_Flow - Temp[20 + Hour_Index];
    
    // 保存各3小时区间的累计值
    CASE Hour_Index OF
        0: Out_Tot_3H_00_03 := In_Flow - Temp[20];
        1: Out_Tot_3H_03_06 := In_Flow - Temp[21];
        2: Out_Tot_3H_06_09 := In_Flow - Temp[22];
        3: Out_Tot_3H_09_12 := In_Flow - Temp[23];
        4: Out_Tot_3H_12_15 := In_Flow - Temp[24];
        5: Out_Tot_3H_15_18 := In_Flow - Temp[25];
        6: Out_Tot_3H_18_21 := In_Flow - Temp[26];
        7: Out_Tot_3H_21_24 := In_Flow - Temp[27];
    END_CASE;
END_IF;

// 3小时区间结束处理 - 重置
// 触发条件: 区间切换后 2-3 秒
IF (Last_Hour_Index <> Hour_Index) AND (Second >= 2) AND (Second <= 3) THEN
    // 区间切换时,不需要清零临时变量
    // 因为 Temp[20+Hour_Index] 会在进入新区间时重新赋值
END_IF;

// ===============================================================
// 功能段 6: 班实时累计输出
// 执行频率: 每次扫描
// 说明: 根据当前时间输出对应的班实时累计值
// ===============================================================
// 输出当前班次的实时累计值
// 条件判断:
// - 如果在白班时间段内,输出白班实时累计值
// - 否则,输出夜班实时累计值
IF (Time_Real >= Time_Set1) AND (Time_Real < Time_Set2) THEN
    Out_Tot_Class_RT := Out_Tot_Class1_RT;
ELSE
    Out_Tot_Class_RT := Out_Tot_Class2_RT;
END_IF;

// ===============================================================
// 功能段 7: HMI 命令处理
// 执行频率: 每次扫描
// 说明: 处理 HMI 发送的控制命令
// ===============================================================
// 处理 HMI 清除命令
// 触发条件: HMI_CMD.Clear = 1 (HMI 发送清除命令)
// 操作: 清零所有累计值
IF HMI_CMD.Clear THEN
    // 清零所有输出累计值
    Out_Tot := 0;
    Out_Tot_Class_RT := 0;
    Out_Tot_Class1 := 0;
    Out_Tot_Class1_RT := 0;
    Out_Tot_Class2 := 0;
    Out_Tot_Class2_RT := 0;
    Out_Tot_3H_RT := 0;
    Out_Tot_3H_00_03 := 0;
    Out_Tot_3H_03_06 := 0;
    Out_Tot_3H_06_09 := 0;
    Out_Tot_3H_09_12 := 0;
    Out_Tot_3H_12_15 := 0;
    Out_Tot_3H_15_18 := 0;
    Out_Tot_3H_18_21 := 0;
    Out_Tot_3H_21_24 := 0;
    
    // 清零标志位
    Flag_Class1_Start := FALSE;
    Flag_Class2_Start := FALSE;
    Last_Hour_Index := -1;
    
    // 清零临时累计变量
    Temp[10] := 0;  // 白班初始值
    Temp[11] := 0;  // 夜班初始值
    Temp[20] := 0;  // 00:00-03:00 初始值
    Temp[21] := 0;  // 03:00-06:00 初始值
    Temp[22] := 0;  // 06:00-09:00 初始值
    Temp[23] := 0;  // 09:00-12:00 初始值
    Temp[24] := 0;  // 12:00-15:00 初始值
    Temp[25] := 0;  // 15:00-18:00 初始值
    Temp[26] := 0;  // 18:00-21:00 初始值
    Temp[27] := 0;  // 21:00-24:00 初始值
    
    // 清零 HMI 清除命令位 (防止重复执行)
    HMI_CMD.Clear := 0;
END_IF;

// ===============================================================
// 功能段 8: HMI 数据同步
// 执行频率: 每次扫描
// 说明: 将累计值同步到 HMI 命令块
// ===============================================================
// 同步累计值到 HMI 命令块
HMI_CMD.Out_Tot := Out_Tot;
HMI_CMD.Out_Tot_Class_RT := Out_Tot_Class_RT;
HMI_CMD.Out_Tot_Class1 := Out_Tot_Class1;
HMI_CMD.Out_Tot_Class1_RT := Out_Tot_Class1_RT;
HMI_CMD.Out_Tot_Class2 := Out_Tot_Class2;
HMI_CMD.Out_Tot_Class2_RT := Out_Tot_Class2_RT;
HMI_CMD.Out_Tot_3H_RT := Out_Tot_3H_RT;
HMI_CMD.Out_Tot_3H_00_03 := Out_Tot_3H_00_03;
HMI_CMD.Out_Tot_3H_03_06 := Out_Tot_3H_03_06;
HMI_CMD.Out_Tot_3H_06_09 := Out_Tot_3H_06_09;
HMI_CMD.Out_Tot_3H_09_12 := Out_Tot_3H_09_12;
HMI_CMD.Out_Tot_3H_12_15 := Out_Tot_3H_12_15;
HMI_CMD.Out_Tot_3H_15_18 := Out_Tot_3H_15_18;
HMI_CMD.Out_Tot_3H_18_21 := Out_Tot_3H_18_21;
HMI_CMD.Out_Tot_3H_21_24 := Out_Tot_3H_21_24;

// ===============================================================
// 功能段 9: 启用状态输出
// 执行频率: 每次扫描
// 说明: 设置 AOI 的启用状态输出
// ===============================================================
// 设置 AOI 启用状态输出
EnableOut := EnableIn;

// ===============================================================
// 程序结束
// ===============================================================
// 总结:
// 本程序实现了一个完整的多维度流量计累计量统计系统,具有以下特点:
// 1. 支持 3 个时间维度的累计 (总/班/3小时区间)
// 2. 自动切换累计维度,无需人工干预
// 3. 实时累计与历史累计分离,数据安全可靠
// 4. 支持 HMI 交互,可手动清除累计值
// 5. 代码结构清晰,注释详细,易于维护和扩展
// ===============================================================