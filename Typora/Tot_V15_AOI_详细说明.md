---
title: Tot_V15 AOI 详细说明文档 - 多维度产量累计统计系统
author: Code Builder
description: Tot_V15 AOI 是一个多维度产量累计统计系统，支持总累计、分钟累计、班累计、天累计和月累计，适用于 Rockwell Automation Studio 5000 平台
keywords:
- Tot_V15, AOI, Add-On Instruction, Structured Text, ST, Rockwell Automation, Studio 5000, ControlLogix, CompactLogix
- 产量统计, 累计计数, 多维度累计, 班累计, 天累计, 月累计, 分钟累计
- 工业自动化, 生产管理, 数据采集, HMI, PLC, 控制器
- 班次切换, 日期切换, 月份切换, 自动切换, 数据持久化
- 脉冲检测, OSRI, 定时器, TONR, 时间处理
---

[TOC]

# ==概述==

## 基本信息

- **AOI 名称**: Tot_V15
- **版本**: 1.2
- **类型**: Add-On Instruction (AOI)
- **编程语言**: Structured Text (ST)
- **适用平台**: Rockwell Automation Studio 5000
- **控制器系列**: ControlLogix / CompactLogix
- **软件版本**: Studio 5000 v33.00 及以上

## 功能定位

Tot_V15 是一个**多维度产量累计统计系统**，用于工业生产过程中的产量数据采集和统计。该系统支持多种时间维度的累计计数，能够自动进行班次切换、日期切换和月份切换，为生产管理提供准确的产量数据。

## 应用场景

- **制造业**: 生产线产量统计
- **矿业**: 矿石开采量统计
- **包装行业**: 产品包装数量统计
- **物流行业**: 货物处理量统计
- **任何需要产量统计的工业场景**

---

# ==功能特性==

## 多维度累计

| 累计维度 | 说明 | 典型应用 |
|---------|------|--------|
| **总累计** | 从系统启动开始的累计值，不自动清零 | 设备总生产量统计 |
| **分钟累计** | 每 n 分钟的累计值，可配置 | 即时产量监控、产量趋势分析 |
| **班累计** | 白班/夜班的累计值，自动切换 | 班组产量考核、班次对比 |
| **天累计** | 每天的累计值，00:00 切换 | 日产量报表、生产日报 |
| **月累计** | 每月的累计值，月初切换 | 月产量报表、生产月报 |

## 核心特性

1. **实时累计与历史累计分离**
   - 实时累计值（`_RT` 后缀）随时间变化，用于实时显示
   - 历史累计值在切换时刻冻结保存，用于数据查询

2. **自动切换**
   - 根据系统时间自动判断当前时间段
   - 自动切换累计维度，无需人工干预

3. **数据持久化**
   - 历史累计值在切换时刻保存，不会丢失
   - 支持掉电保持（需在控制器中配置）

4. **高度可配置**
   - 班次切换时间可配置
   - 累计周期可配置
   - 缩放系数可配置

5. **HMI 交互**
   - 支持 HMI 实时显示所有累计值
   - 支持 HMI 手动清除累计值
   - 提供标准的数据接口

6. **可靠性设计**
   - 脉冲上升沿检测，防止重复计数
   - 运行状态判断，确保只有在设备运行时才计数
   - 延迟清零机制，确保数据保存完整

---

# ==系统架构==

## 整体架构

```text
┌─────────────────────────────────────────────────────────────┐
│                    Tot_V15 AOI                             │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  输入参数   │  │  输出参数   │  │  输入输出   │         │
│  │  (Inputs)   │  │  (Outputs)  │  │  (InOut)    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│         │                │                │                │
│         ▼                ▼                ▼                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              核心逻辑处理单元                        │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │   │
│  │  │脉冲检测 │ │时间处理 │ │累计计数 │ │数据同步 │   │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
│         │                │                │                │
│         ▼                ▼                ▼                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  本地标签   │  │   定时器    │  │   HMI_CMD   │         │
│  │  (LocalTags)│  │  (TONR)     │  │  (数据块)   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

## 数据流向

```text
输入信号
  │
  ├─ In_Pulse (脉冲输入)
  │   └─ 上升沿检测 (OSRI)
  │       └─ 累计计数
  │           ├─ 总累计 (Out_Tot)
  │           ├─ 分钟累计 (Out_Tot_Min)
  │           ├─ 班累计 (Out_Tot_Class1/2)
  │           ├─ 天累计 (Out_Tot_D)
  │           └─ 月累计 (Out_Tot_M)
  │
  ├─ In_Run (运行状态)
  │   └─ 使能控制
  │       ├─ 允许累计计数
  │       └─ 定时器使能
  │
  ├─ 时间输入 (Year/Month/Day/Hour/Minute/Second)
  │   └─ 时间判断
  │       ├─ 班次切换判断
  │       ├─ 日期切换判断
  │       └─ 月份切换判断
  │
  └─ 配置参数 (In_Class1_Time, In_Tot_Min 等)
      └─ 累计周期配置

输出数据
  ├─ 实时累计值 (Out_Tot_*_RT)
  │   └─ HMI 实时显示
  │
  ├─ 历史累计值 (Out_Tot_*)
  │   └─ 数据查询、报表生成
  │
  └─ HMI_CMD (数据块)
      └─ HMI 数据交互
```

## 核心组件

### 脉冲检测单元

- **功能**: 检测输入脉冲的上升沿
- **实现**: 使用 OSRI (One Shot Rising Input) 指令
- **作用**: 确保每个脉冲只计数一次，防止重复计数

### 时间处理单元

- **功能**: 读取系统时间，计算时间偏移量
- **实现**: 时间数组 + 分钟偏移量计算
- **作用**: 为时间段判断提供数据支持

### 累计计数单元

- **功能**: 根据不同时间维度进行累计计数
- **实现**: IF 条件判断 + 累加操作
- **作用**: 实现多维度的累计统计

### 数据同步单元

- **功能**: 将累计值同步到 HMI 数据块
- **实现**: 数据复制操作
- **作用**: 实现 PLC 与 HMI 之间的数据交互

---

# ==参数说明==

## 输入参数 (Inputs)

| 参数名称 | 数据类型 | 默认值 | 说明 | 典型值 |
|---------|---------|-------|------|--------|
| **EnableIn** | BOOL | - | AOI 启用输入 | 1 (启用) |
| **In_Pulse** | BOOL | 0 | 脉冲输入 (上升沿触发) | 来自传感器 |
| **In_Run** | BOOL | 0 | 设备运行状态 | 1 (运行) |
| **In_Scale** | DINT | 0 | 缩放系数 (每脉冲产量) | 10 (每10脉冲=1件) |
| **Year** | DINT | 0 | 年份 | 2024 |
| **Month** | DINT | 0 | 月份 (1-12) | 1-12 |
| **Day** | DINT | 0 | 日期 (1-31) | 1-31 |
| **Hour** | DINT | 0 | 小时 (0-23) | 0-23 |
| **Minute** | DINT | 0 | 分钟 (0-59) | 0-59 |
| **Second** | DINT | 0 | 秒 (0-59) | 0-59 |
| **In_Tot_Min** | DINT | 0 | 分钟累计周期 (分钟) | 5 (每5分钟) |
| **In_Class1_Time_Hour** | DINT | 0 | 白班开始小时 | 8 (08:00) |
| **In_Class1_Time_Minute** | DINT | 0 | 白班开始分钟 | 0 (08:00) |
| **In_Class2_Time_Hour** | DINT | 0 | 夜班开始小时 | 20 (20:00) |
| **In_Class2_Time_Minute** | DINT | 0 | 夜班开始分钟 | 0 (20:00) |
| **In_Day_Time_Hour** | DINT | 0 | 天切换小时 | 0 (00:00) |
| **In_Day_Time_Minute** | DINT | 0 | 天切换分钟 | 0 (00:00) |

## 输出参数 (Outputs)

| 参数名称 | 数据类型 | 说明 | 用途 |
|---------|---------|------|------|
| **EnableOut** | BOOL | AOI 启用状态输出 | 指示 AOI 是否正在执行 |
| **Out_Tot** | REAL | 总累计值 | 设备总生产量 |
| **Out_Tot_Min** | REAL | 分钟累计值 | 即时产量监控 |
| **Out_Tot_Class_RT** | REAL | 班实时累计值 | 当前班次产量 |
| **Out_Tot_D_RT** | REAL | 天实时累计值 | 当日产量 |
| **Out_Tot_M_RT** | REAL | 月实时累计值 | 当月产量 |
| **Out_Tot_D** | REAL | 昨天累计值 | 昨日产量查询 |
| **Out_Tot_M** | REAL | 上个月累计值 | 上月产量查询 |
| **Out_Tot_Class1** | REAL | 白班累计值 | 白班产量查询 |
| **Out_Tot_Class2** | REAL | 夜班累计值 | 夜班产量查询 |

## 输入输出参数 (InOut)

| 参数名称 | 数据类型 | 说明 |
|---------|---------|------|
| **HMI_CMD** | PB_Tot_V15 | HMI 命令数据块 |

### PB_Tot_V15 数据结构

```
PB_Tot_V15
├─ Clear (BIT) - 清除命令
├─ Out_Tot (REAL) - 总累计
├─ Out_Tot_Min (REAL) - 分钟累计
├─ Out_Tot_Class_RT (REAL) - 班实时累计
├─ Out_Tot_Class1 (REAL) - 白班累计
├─ Out_Tot_Class2 (REAL) - 夜班累计
├─ Out_Tot_D (REAL) - 昨天累计
├─ Out_Tot_D_RT (REAL) - 天实时累计
├─ Out_Tot_M (REAL) - 上个月累计
└─ Out_Tot_M_RT (REAL) - 月实时累计
```

## 本地标签 (Local Tags)

| 标签名称 | 数据类型 | 说明 | 用途 |
|---------|---------|------|------|
| **Current_Shift** | SINT | 当前班次标识 | 1=白班, 2=夜班 |
| **Shift_Change_Flag** | BOOL | 班次切换标志 | 指示是否发生班次切换 |
| **Day_Change_Flag** | BOOL | 日期切换标志 | 指示是否发生日期切换 |
| **Temp[32]** | REAL[32] | 临时累计数组 | 存储各维度的临时累计值 |
| **TONR_01** | FBD_TIMER | 分钟累计定时器 | 实现 n 分钟累计 |
| **OSRI_Pulse** | FBD_ONESHOT | 脉冲上升沿检测器 | 检测脉冲上升沿 |
| **Time[8]** | DINT[8] | 时间数组 | 存储系统时间 |
| **Out_Tot_Class1_RT** | REAL | 白班实时累计 | 白班实时产量 |
| **Out_Tot_Class2_RT** | REAL | 夜班实时累计 | 夜班实时产量 |
| **Time_Set1** | DINT | 白班开始时间偏移 | 班次切换判断 |
| **Time_Set2** | DINT | 夜班开始时间偏移 | 班次切换判断 |
| **Time_Set3_Day** | DINT | 天切换时间偏移 | 日期切换判断 |
| **Time_Real** | DINT | 当前时间偏移 | 时间段判断 |
| **Is_Leap_Year** | BOOL | 闰年标志 | 2月天数判断 |
| **Days_In_Month** | DINT | 当月天数 | 月份累计判断 |

---

# ==核心逻辑详解==

## 脉冲检测与总累计

### 工作原理

```
输入脉冲 (In_Pulse)
    │
    ▼
┌──────────────┐
│  OSRI 检测   │ ── 检测上升沿
└──────────────┘
    │
    ▼
┌──────────────┐
│  运行状态判断│ ── In_Run = 1?
└──────────────┘
    │ (是)
    ▼
┌──────────────┐
│  累计计数    │ ── Out_Tot += In_Scale
└──────────────┘
```

### 关键代码

```st
// 脉冲上升沿检测
OSRI_Pulse.InputBit := In_Pulse;
OSRI(OSRI_Pulse);

// 总累计计数
IF OSRI_Pulse.OutputBit AND In_Run THEN
    Out_Tot := Out_Tot + In_Scale;
    Temp[0] := Temp[0] + In_Scale;
END_IF;
```

### 设计要点

1. **上升沿检测**: 使用 OSRI 指令确保每个脉冲只计数一次
2. **运行状态判断**: 只有在设备运行时才计数，确保数据准确性
3. **缩放系数**: 支持脉冲数到实际产量的转换

## 分钟累计

### 工作原理

```
定时器配置
    │
    ├─ PRE = In_Tot_Min * 60000 (预设值，毫秒)
    ├─ Reset = DN (完成时自动复位)
    └─ TimerEnable = In_Run (运行时计时)
    │
    ▼
┌──────────────┐
│  TONR 定时器 │ ── 计时
└──────────────┘
    │
    ▼ (计时完成)
┌──────────────┐
│  更新累计值  │ ── Out_Tot_Min := Temp[0]
└──────────────┘
    │
    ▼
┌──────────────┐
│  清零临时值  │ ── Temp[0] := 0
└──────────────┘
```

### 关键代码

```st
// 定时器配置
TONR_01.PRE := In_Tot_Min * 60000;
TONR_01.Reset := TONR_01.DN;
TONR_01.TimerEnable := In_Run;
TONR(TONR_01);

// 计时完成处理
IF TONR_01.DN THEN
    Out_Tot_Min := Temp[0];
    Temp[0] := 0;
END_IF;
```

### 设计要点

1. **TONR 定时器**: 可保持型通电延时定时器
2. **自动复位**: 计时完成后自动复位，开始下一个周期
3. **运行使能**: 仅在设备运行时计时，确保累计准确性

## 班累计（白班/夜班）

### 工作原理

```
系统时间
    │
    ▼
┌──────────────┐
│ 计算时间偏移 │ ── Time_Real = Hour*60 + Minute
└──────────────┘
    │
    ▼
┌──────────────┐
│ 时间段判断   │ ── 白班? 夜班?
└──────────────┘
    │
    ├─ 白班 (Time_Set1 <= Time_Real < Time_Set2)
    │   └─ 累计到 Temp[10]
    │
    └─ 夜班 (Time_Real >= Time_Set2 OR Time_Real < Time_Set1)
        └─ 累计到 Temp[11]
```

### 切换逻辑

| 时间点 | 操作 | 说明 |
|-------|------|------|
| 切换时刻 0-1 秒 | 保存累计值 | 将临时累计值保存到历史累计值 |
| 切换时刻 2-3 秒 | 清零临时值 | 清零临时累计变量，准备下一个周期 |

### 关键代码

```st
// 白班累计
IF (Time_Real >= Time_Set1) AND (Time_Real < Time_Set2) AND OSRI_Pulse.OutputBit AND In_Run THEN
    Temp[10] := Temp[10] + In_Scale;
END_IF;

// 白班结束保存
IF (Hour = In_Class2_Time_Hour) AND (Minute = In_Class2_Time_Minute) AND (Second <= 1) THEN
    Out_Tot_Class1 := Temp[10];
    Out_Tot_Class1_RT := 0;
END_IF;

// 白班结束清零
IF (Hour = In_Class2_Time_Hour) AND (Minute = In_Class2_Time_Minute) AND (Second >= 2) AND (Second <= 3) THEN
    Temp[10] := 0;
END_IF;
```

### 设计要点

1. **时间段判断**: 使用分钟偏移量进行比较，逻辑清晰
2. **夜班跨天**: 使用 OR 条件处理夜班跨 midnight 的情况
3. **延迟清零**: 延迟 2 秒清零确保数据保存完整

## 天累计

### 工作原理

```
脉冲输入
    │
    ▼
┌──────────────┐
│  累计计数    │ ── Temp[8] += In_Scale
└──────────────┘
    │
    ▼
┌──────────────┐
│ 实时累计更新 │ ── Out_Tot_D_RT := Temp[8]
└──────────────┘
    │
    ▼ (到达切换时间)
┌──────────────┐
│ 保存累计值   │ ── Out_Tot_D := Temp[8]
└──────────────┘
    │
    ▼ (延迟 2 秒)
┌──────────────┐
│ 清零临时值   │ ── Temp[8] := 0
└──────────────┘
```

### 关键代码

```st
// 天累计计数
IF OSRI_Pulse.OutputBit AND In_Run THEN
    Temp[8] := Temp[8] + In_Scale;
END_IF;

// 实时累计更新
Out_Tot_D_RT := Temp[8];

// 天结束处理
IF (Hour = In_Day_Time_Hour) AND (Minute = In_Day_Time_Minute) AND (Second <= 1) THEN
    Out_Tot_D := Temp[8];
    Out_Tot_D_RT := 0;
END_IF;

IF (Hour = In_Day_Time_Hour) AND (Minute = In_Day_Time_Minute) AND (Second >= 2) AND (Second <= 3) THEN
    Temp[8] := 0;
END_IF;
```

## 月累计

### 工作原理

```
系统时间
    │
    ▼
┌──────────────┐
│ 闰年判断     │ ── Is_Leap_Year = (Year MOD 4 = 0) AND ...
└──────────────┘
    │
    ▼
┌──────────────┐
│ 月份天数计算 │ ── CASE Month OF ...
└──────────────┘
    │
    ▼
┌──────────────┐
│ 有效日期判断 │ ── Day >= 1 AND Day <= Days_In_Month
└──────────────┘
    │
    ▼
┌──────────────┐
│ 累计计数     │ ── Temp[4] += In_Scale
└──────────────┘
```

### 月份天数规则

| 月份 | 天数 | 说明 |
|-----|------|------|
| 1, 3, 5, 7, 8, 10, 12 | 31 天 | 大月 |
| 4, 6, 9, 11 | 30 天 | 小月 |
| 2 | 28 天 | 平年 |
| 2 | 29 天 | 闰年 |

### 闰年规则

```
闰年条件 = (能被 4 整除 且 不能被 100 整除) 或 (能被 400 整除)

示例:
- 2000 年: 2000 MOD 400 = 0 → 闰年
- 2004 年: 2004 MOD 4 = 0 且 2004 MOD 100 ≠ 0 → 闰年
- 1900 年: 1900 MOD 4 = 0 但 1900 MOD 100 = 0 → 平年
- 2024 年: 2024 MOD 4 = 0 且 2024 MOD 100 ≠ 0 → 闰年
```

### 关键代码

```st
// 闰年判断
Is_Leap_Year := (Year MOD 4 = 0) AND (Year MOD 100 <> 0) OR (Year MOD 400 = 0);

// 月份天数计算
CASE Month OF
    1, 3, 5, 7, 8, 10, 12: Days_In_Month := 31;
    4, 6, 9, 11: Days_In_Month := 30;
    2:
        IF Is_Leap_Year THEN
            Days_In_Month := 29;
        ELSE
            Days_In_Month := 28;
        END_IF;
END_CASE;

// 月累计计数
IF (Day >= 1) AND (Day <= Days_In_Month) AND OSRI_Pulse.OutputBit AND In_Run THEN
    Temp[4] := Temp[4] + In_Scale;
END_IF;
```

### 设计要点

1. **CASE 语句**: 使用 CASE 替代复杂的 IF 嵌套，提高可读性
2. **闰年处理**: 准确的闰年判断逻辑
3. **有效日期判断**: 确保只在当月有效日期内累计

## HMI 命令处理

### 清除命令处理

```st
IF HMI_CMD.Clear THEN
    // 清零所有累计值
    Out_Tot := 0;
    Out_Tot_Min := 0;
    // ... 其他累计值清零
    
    // 清零临时变量
    Temp[0] := 0;
    Temp[4] := 0;
    // ... 其他临时变量清零
    
    // 清除命令位
    HMI_CMD.Clear := 0;
END_IF;
```

### 数据同步

```st
// 将累计值同步到 HMI 数据块
HMI_CMD.Out_Tot := Out_Tot;
HMI_CMD.Out_Tot_Min := Out_Tot_Min;
HMI_CMD.Out_Tot_Class_RT := Out_Tot_Class_RT;
// ... 其他累计值同步
```

---

# ==使用示例==

## 基本使用

### 在梯形图中调用

```
┌────────────────────────────────────────┐
│         Tot_V15 (AOI 调用)             │
├────────────────────────────────────────┤
│ EnableIn:    ───────┤ 1 (启用)        │
│ In_Pulse:    ───────┤ I:1/0 (脉冲输入)│
│ In_Run:      ───────┤ I:1/1 (运行信号)│
│ In_Scale:    ───────┤ 10 (缩放系数)   │
│ Year:        ───────┤ Local:Year      │
│ Month:       ───────┤ Local:Month     │
│ Day:         ───────┤ Local:Day       │
│ Hour:        ───────┤ Local:Hour      │
│ Minute:      ───────┤ Local:Minute    │
│ Second:      ───────┤ Local:Second    │
│ In_Tot_Min:  ───────┤ 5 (5分钟累计)   │
│ In_Class1_Time_Hour: ──┤ 8 (白班8点)  │
│ In_Class2_Time_Hour: ──┤ 20 (夜班20点)│
│ ... 其他配置参数                       │
├────────────────────────────────────────┤
│ EnableOut:   ───────┤ O:1/0           │
│ Out_Tot:     ───────┤ D100 (总累计)   │
│ Out_Tot_Min: ───────┤ D101 (分钟累计) │
│ Out_Tot_Class_RT: ──┤ D102 (班实时)   │
│ Out_Tot_D_RT: ─────┤ D103 (天实时)    │
│ Out_Tot_M_RT: ─────┤ D104 (月实时)    │
│ Out_Tot_D:   ───────┤ D105 (昨天累计) │
│ Out_Tot_M:   ───────┤ D106 (上月累计) │
│ Out_Tot_Class1: ───┤ D107 (白班累计)  │
│ Out_Tot_Class2: ───┤ D108 (夜班累计)  │
│ HMI_CMD:     ───────┤ PB100 (数据块)  │
└────────────────────────────────────────┘
```

## 配置示例

### 典型配置

```st
// 基本配置
EnableIn := TRUE;
In_Scale := 10;  // 每10个脉冲 = 1件产品

// 时间输入 (从控制器获取)
Year := Local:1.Year;
Month := Local:1.Month;
Day := Local:1.Day;
Hour := Local:1.Hour;
Minute := Local:1.Minute;
Second := Local:1.Second;

// 累计周期配置
In_Tot_Min := 5;  // 每5分钟累计

// 班次配置
In_Class1_Time_Hour := 8;    // 白班 08:00 开始
In_Class1_Time_Minute := 0;
In_Class2_Time_Hour := 20;   // 夜班 20:00 开始
In_Class2_Time_Minute := 0;

// 天切换配置
In_Day_Time_Hour := 0;       // 00:00 切换
In_Day_Time_Minute := 0;
```

---

# ==配置指南==

## 配置步骤

### 1. 导入 AOI

1. 在 Studio 5000 中打开项目
2. 右键点击 **Add-On Instructions**
3. 选择 **Import**
4. 选择 Tot_V15_AOI.L5X 文件
5. 点击 **OK** 完成导入

### 2. 创建数据类型

```
// 创建 PB_Tot_V15 数据类型
Data Type: PB_Tot_V15
Structure:
    Clear (BIT)
    Out_Tot (REAL)
    Out_Tot_Min (REAL)
    Out_Tot_Class_RT (REAL)
    Out_Tot_Class1 (REAL)
    Out_Tot_Class2 (REAL)
    Out_Tot_D (REAL)
    Out_Tot_D_RT (REAL)
    Out_Tot_M (REAL)
    Out_Tot_M_RT (REAL)
```

### 3. 配置标签

```
// 创建输入标签
I:1/0 - 脉冲输入 (In_Pulse)
I:1/1 - 运行信号 (In_Run)

// 创建输出标签
O:1/0 - AOI 启用状态 (EnableOut)

// 创建累计值标签
D100 - D108 (累计值，见参数说明)

// 创建 HMI 数据块
PB100 - HMI_CMD (PB_Tot_V15 类型)
```

### 4. 配置掉电保持

1. 在控制器属性中选择 **Power Up**
2. 选择 **Retentive Tags**
3. 添加需要掉电保持的累计值标签
4. 点击 **Apply** 保存配置

---

# ==故障排查==

## 常见问题

### 问题 1: 累计值不增加

**症状**: 脉冲输入正常，但累计值不变化

**可能原因**:
1. EnableIn 未启用
2. In_Run 运行信号为 0
3. OSRI 检测故障
4. 标签地址配置错误

**排查步骤**:
1. 检查 EnableIn 是否为 1
2. 检查 In_Run 是否为 1
3. 监控 OSRI_Pulse.OutputBit 是否有脉冲输出
4. 验证标签地址是否正确

**解决方案**:
- 启用 EnableIn
- 确保 In_Run 信号正确连接
- 检查 OSRI 指令配置

### 问题 2: 班次切换异常

**症状**: 班次切换时间不准确或累计值丢失

**可能原因**:
1. 系统时间不准确
2. 班次时间配置错误
3. 切换逻辑冲突

**排查步骤**:
1. 检查控制器系统时间
2. 验证 In_Class1_Time 和 In_Class2_Time 配置
3. 监控 Time_Real 计算是否正确

**解决方案**:
- 同步控制器系统时间
- 修正班次时间配置
- 检查时间偏移计算逻辑

### 问题 3: 月累计不正确

**症状**: 月份累计值与实际产量不符

**可能原因**:
1. 闰年判断错误
2. 月份天数计算错误
3. 日期输入错误

**排查步骤**:
1. 检查 Is_Leap_Year 标志
2. 验证 Days_In_Month 计算
3. 检查日期输入是否正确

**解决方案**:
- 修正闰年判断逻辑
- 检查 CASE 语句配置
- 确保日期输入准确

### 问题 4: HMI 无法显示数据

**症状**: HMI 画面无数据显示或显示错误

**可能原因**:
1. HMI_CMD 数据块未配置
2. 数据同步逻辑错误
3. HMI 标签地址错误

**排查步骤**:
1. 检查 HMI_CMD 是否正确连接
2. 监控数据同步逻辑执行
3. 验证 HMI 标签地址映射

**解决方案**:
- 正确配置 HMI_CMD 数据块
- 检查数据同步代码
- 修正 HMI 标签地址

---

# ==维护建议==

## 日常维护

### 定期检查

1. **每日检查**:
   - 验证累计值准确性
   - 检查班次切换是否正常
   - 确认数据同步到 HMI

2. **每周检查**:
   - 备份累计数据
   - 检查系统时间准确性
   - 验证掉电保持配置

3. **每月检查**:
   - 审查月累计数据
   - 检查闰年处理逻辑 (2月)
   - 优化配置参数

## 数据备份

### 备份策略

```
备份频率:
- 每日: 备份天累计数据
- 每月: 备份月累计数据
- 每年: 备份全年数据

备份介质:
- PLC 内部存储 (掉电保持)
- 外部存储设备
- HMI 历史数据记录
```

### 恢复流程

1. 确认故障原因
2. 停止 AOI 执行
3. 从备份恢复数据
4. 重新配置参数
5. 启用 AOI 并监控

## 性能优化

### 优化建议

1. **减少扫描时间**:
   - 优化条件判断逻辑
   - 减少不必要的计算
   - 使用高效的数据结构

2. **提高可靠性**:
   - 添加错误检测机制
   - 实现数据校验
   - 增加异常处理

3. **扩展功能**:
   - 添加更多累计维度
   - 实现数据导出功能
   - 集成到 MES 系统

---

# ==附录==

## 版本历史

| 版本 | 日期 | 说明 |
|-----|------|------|
| 1.0 | 2024-01-15 | 初始版本 |
| 1.1 | 2024-03-20 | 优化班次切换逻辑 |
| 1.2 | 2024-06-10 | 增加月累计闰年处理，优化 HMI 交互 |

## 技术支持

- **文档版本**: 1.2
- **最后更新**: 2024-06-10
- **联系方式**: 请通过项目仓库提交 Issue

## 许可协议

本 AOI 遵循 MIT 开源协议，可自由使用、修改和分发。

---

*==文档完成==*
