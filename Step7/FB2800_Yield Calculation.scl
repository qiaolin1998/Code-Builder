FUNCTION_BLOCK FB2800 
 
 TITLE = 'YieldCalculation' 
 // 
 // 主要用于计算班、年、月、日产量， 
 // 增加早班、中班、晚班每两小时的产量计算
 // 
 VERSION: '1.3' 
 AUTHOR: QIAO 
 NAME:ProCount
 FAMILY:QFam
 
 
 
 //输入 
 VAR_INPUT 
 //实时实时皮带秤总累计量 
 Product_Total:REAL; 
 //初始化信号（上升沿有效）
 Initialize:BOOL;
 END_VAR 
  
  
  //输出 
 VAR_OUTPUT 
 
Product_Early_Class:REAL:=0.0;      //早班产量（9:00-17:00）
Product_Middle_Class:REAL:=0.0;    //中班产量（17:00-1:00）
Product_Late_Class:REAL:=0.0;     //晚班产量（1:00-9:00）
Product_Day:REAL:=0.0;           //日产量 
Product_Month:REAL:=0.0;        //月产量 
Product_Year:REAL:=0.0;        //年产量 
Product_LastMonth:REAL:=0.0;  //上月产量
Product_Yesterday:REAL:=0.0; //昨天产量
//早班每两小时产量
 Product_Early_2H_1:REAL:=0.0;      //早班第一段(9:00-11:00)
 Product_Early_2H_2:REAL:=0.0;      //早班第二段(11:00-13:00)
 Product_Early_2H_3:REAL:=0.0;      //早班第三段(13:00-15:00)
 Product_Early_2H_4:REAL:=0.0;      //早班第四段(15:00-17:00)
 //中班每两小时产量
 Product_Middle_2H_1:REAL:=0.0;     //中班第一段(17:00-19:00)
 Product_Middle_2H_2:REAL:=0.0;     //中班第二段(19:00-21:00)  
 Product_Middle_2H_3:REAL:=0.0;     //中班第三段(21:00-23:00)
 Product_Middle_2H_4:REAL:=0.0;     //中班第四段(23:00-1:00)
 //晚班每两小时产量
 Product_Late_2H_1:REAL:=0.0;      //晚班第一段(1:00-3:00)
 Product_Late_2H_2:REAL:=0.0;      //晚班班第二段(3:00-5:00)
 Product_Late_2H_3:REAL:=0.0;      //晚班第三段(5:00-7:00)
 Product_Late_2H_4:REAL:=0.0;      //晚班第四段(7:00-9:00)
 //初始化完成标志
 Init_Done:BOOL:=FALSE; 
 END_VAR 
 
 // Temporary Variables 
 VAR_TEMP 
           Read_Return :INT ; 
 END_VAR 
 
 // Static Variables 
 VAR 
       //当前时间 
      DateAndTimeNow:DATE_AND_TIME; 
      //时间结构体 
      DateAndTimeNowCoporate AT DateAndTimeNow:STRUCT 
      Year:BYTE; 
      Month:BYTE; 
      Day:BYTE; 
      Hour:BYTE; 
      Minute:BYTE; 
      Second:BYTE; 
      milliSecond:WORD; 
 END_STRUCT; 
     //存储当前时间变量 
      YearNow:INT; 
      MonthNow:INT; 
      DayNow:INT; 
      HourNow:INT; 
      MinuteNow:INT; 
      SecondNow:INT; 
      //存储上一次扫描的时间变量
      HourLast:INT; 
      MinuteLast:INT; 
      SecondLast:INT; 
      DayLast:INT; 
      MonthLast:INT; 
      YearLast:INT; 
      //月、年时间一次存储变量 
      MonthNowFormer:INT; 
      YearNowFormer:INT; 
      DayNowFormer:INT; 
 
      //开班、日、月、年时间的产量 
      StartEarlyClassPro:REAL:=0.0; 
      StartMiddleClassPro:REAL:=0.0; 
      StartLateClassPro:REAL:=0.0; 
      StartDayClassPro:REAL:=0.0; 
      StartMonthClassPro:REAL:=0.0; 
      StartYearClassPro:REAL:=0.0; 
      //早班每两小时产量起始值
      StartEarly_2H_1:REAL:=0.0; //早班第一段(9:00-11:00)
      StartEarly_2H_2:REAL:=0.0; //早班第二段(11:00-13:00)
      StartEarly_2H_3:REAL:=0.0; //早班第三段(13:00-15:00)
      StartEarly_2H_4:REAL:=0.0; //早班第四段(15:00-17:00)
      //中班每两小时产量起始值
      StartMiddle_2H_1:REAL:=0.0; //中班第一段(17:00-19:00)
      StartMiddle_2H_2:REAL:=0.0; //中班第二段(19:00-21:00)
      StartMiddle_2H_3:REAL:=0.0; //中班第三段(21:00-23:00)
      StartMiddle_2H_4:REAL:=0.0; //中班第四段(23:00-1:00)
      //晚班每两小时产量起始值
      StartLate_2H_1:REAL:=0.0; //晚班第一段(1:00-3:00)
      StartLate_2H_2:REAL:=0.0; //晚班第二段(3:00-5:00)
      StartLate_2H_3:REAL:=0.0; //晚班第三段(5:00-7:00)
      StartLate_2H_4:REAL:=0.0; //晚班第四段(7:00-9:00)
      //早班每两小时产量标志位
      Early_2H_1_Flag:BOOL:=FALSE;
      Early_2H_2_Flag:BOOL:=FALSE;
      Early_2H_3_Flag:BOOL:=FALSE;
      Early_2H_4_Flag:BOOL:=FALSE;
      //中班每两小时产量标志位
      Middle_2H_1_Flag:BOOL:=FALSE;
      Middle_2H_2_Flag:BOOL:=FALSE;
      Middle_2H_3_Flag:BOOL:=FALSE;
      Middle_2H_4_Flag:BOOL:=FALSE;
      //晚班每两小时产量标志位
      Late_2H_1_Flag:BOOL:=FALSE;
      Late_2H_2_Flag:BOOL:=FALSE;
      Late_2H_3_Flag:BOOL:=FALSE;
      Late_2H_4_Flag:BOOL:=FALSE;
      
      //首次扫描标志
      IsFirstScan:BOOL:=TRUE;
      //班别标志
      EarlyClassFlag:BOOL:=FALSE;
      MiddleClassFlag:BOOL:=FALSE;
      LateClassFlag:BOOL:=FALSE;
      //产量计算标志
      DayFlag:BOOL:=FALSE;
      MonthFlag:BOOL:=FALSE;
      YearFlag:BOOL:=FALSE;
      //上月产量记录
      LastMonth_Total:REAL:=0.0;
      //昨天产量记录
      Yesterday_Total:REAL:=0.0;

 END_VAR 
 
 //程序逻辑从这里开始 
 //获取系统时间 
 Read_Return:=READ_CLK(CDT :=DateAndTimeNow ); 
 YearNow:=BCD_TO_INT(DateAndTimeNowCoporate.Year); 
 MonthNow:=BCD_TO_INT(DateAndTimeNowCoporate.Month); 
 DayNow:=BCD_TO_INT(DateAndTimeNowCoporate.Day); 
 HourNow:=BCD_TO_INT(DateAndTimeNowCoporate.Hour); 
 MinuteNow:=BCD_TO_INT(DateAndTimeNowCoporate.Minute); 
 SecondNow:=BCD_TO_INT(DateAndTimeNowCoporate.Second); 
 
 // 首次扫描初始化
 IF IsFirstScan THEN
     // 初始化所有开始产量为当前总累计量
     StartEarlyClassPro:=Product_Total;
     StartMiddleClassPro:=Product_Total;
     StartLateClassPro:=Product_Total;
     StartDayClassPro:=Product_Total;
     StartMonthClassPro:=Product_Total;
     StartYearClassPro:=Product_Total;
     // 初始化早班每两小时产量开始值
     StartEarly_2H_1:=Product_Total;
     StartEarly_2H_2:=Product_Total;
     StartEarly_2H_3:=Product_Total;
     StartEarly_2H_4:=Product_Total;
     // 初始化中班每两小时产量开始值
     StartMiddle_2H_1:=Product_Total;
     StartMiddle_2H_2:=Product_Total;
     StartMiddle_2H_3:=Product_Total;
     StartMiddle_2H_4:=Product_Total;
     // 初始化晚班每两小时产量开始值
     StartLate_2H_1:=Product_Total;
     StartLate_2H_2:=Product_Total;
     StartLate_2H_3:=Product_Total;
     StartLate_2H_4:=Product_Total;
     // 保存当前时间作为上一次扫描时间
     YearLast:=YearNow;
     MonthLast:=MonthNow;
     DayLast:=DayNow;
     HourLast:=HourNow;
     MinuteLast:=MinuteNow;
     SecondLast:=SecondNow;
     // 更新标志位
     IsFirstScan:=FALSE;
     Init_Done:=TRUE;
 END_IF;
 
 // 初始化信号处理
 IF Initialize THEN
     // 重置所有开始产量为当前总累计量
     StartEarlyClassPro:=Product_Total;
     StartMiddleClassPro:=Product_Total;
     StartLateClassPro:=Product_Total;
     StartDayClassPro:=Product_Total;
     StartMonthClassPro:=Product_Total;
     StartYearClassPro:=Product_Total;
     // 重置早班每两小时产量开始值
     StartEarly_2H_1:=Product_Total;
     StartEarly_2H_2:=Product_Total;
     StartEarly_2H_3:=Product_Total;
     StartEarly_2H_4:=Product_Total;
     // 重置中班每两小时产量开始值
     StartMiddle_2H_1:=Product_Total;
     StartMiddle_2H_2:=Product_Total;
     StartMiddle_2H_3:=Product_Total;
     StartMiddle_2H_4:=Product_Total;
     // 重置晚班每两小时产量开始值
     StartLate_2H_1:=Product_Total;
     StartLate_2H_2:=Product_Total;
     StartLate_2H_3:=Product_Total;
     StartLate_2H_4:=Product_Total;
     // 重置所有产量为0
     Product_Early_Class:=0.0;
     Product_Middle_Class:=0.0;
     Product_Late_Class:=0.0;
     Product_Day:=0.0;
     Product_Month:=0.0;
     Product_Year:=0.0;
     // 重置早班每两小时产量为0
     Product_Early_2H_1:=0.0;
     Product_Early_2H_2:=0.0;
     Product_Early_2H_3:=0.0;
     Product_Early_2H_4:=0.0;
     // 重置中班每两小时产量为0
     Product_Middle_2H_1:=0.0;
     Product_Middle_2H_2:=0.0;
     Product_Middle_2H_3:=0.0;
     Product_Middle_2H_4:=0.0;
     // 重置晚班每两小时产量为0
     Product_Late_2H_1:=0.0;
     Product_Late_2H_2:=0.0;
     Product_Late_2H_3:=0.0;
     Product_Late_2H_4:=0.0;
     // 更新标志位
     Init_Done:=TRUE;
 END_IF;
 
 // 早班产量计算（9:00-17:00） 
 // 判断是否进入早班时间（9:00:00）
 IF (HourNow =9 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <9 AND HourNow>=9) THEN // 处理跨小时的情况
     StartEarlyClassPro:=Product_Total;
     EarlyClassFlag:=TRUE;
 END_IF;
 
 // 判断是否退出早班时间（17:00:00）
 IF (HourNow =17 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <17 AND HourNow>=17) THEN // 处理跨小时的情况
     EarlyClassFlag:=FALSE;
 END_IF;
 
 // 计算早班产量
 IF HourNow>=9 AND HourNow<17 THEN
    Product_Early_Class:=Product_Total - StartEarlyClassPro;
 END_IF;
 
 // 早班每两小时产量计算
 // 早班第一段(9:00-11:00)
 IF (HourNow =9 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <9 AND HourNow>=9) THEN
     StartEarly_2H_1:=Product_Total;
     Early_2H_1_Flag:=TRUE;
 END_IF;
 
 IF (HourNow =11 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <11 AND HourNow>=11) THEN
     Early_2H_1_Flag:=FALSE;
 END_IF;
 
 IF HourNow>=9 AND HourNow<11 THEN
    Product_Early_2H_1:=Product_Total - StartEarly_2H_1;
 END_IF;
 
 // 早班第二段(11:00-13:00)
 IF (HourNow =11 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <11 AND HourNow>=11) THEN
     StartEarly_2H_2:=Product_Total;
     Early_2H_2_Flag:=TRUE;
 END_IF;
 
 IF (HourNow =13 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <13 AND HourNow>=13) THEN
     Early_2H_2_Flag:=FALSE;
 END_IF;
 
 IF HourNow>=11 AND HourNow<13 THEN
    Product_Early_2H_2:=Product_Total - StartEarly_2H_2;
 END_IF;
 
 // 早班第三段(13:00-15:00)
 IF (HourNow =13 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <13 AND HourNow>=13) THEN
     StartEarly_2H_3:=Product_Total;
     Early_2H_3_Flag:=TRUE;
 END_IF;
 
 IF (HourNow =15 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <15 AND HourNow>=15) THEN
     Early_2H_3_Flag:=FALSE;
 END_IF;
 
 IF HourNow>=13 AND HourNow<15 THEN
    Product_Early_2H_3:=Product_Total - StartEarly_2H_3;
 END_IF;
 
 // 早班第四段(15:00-17:00)
 IF (HourNow =15 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <15 AND HourNow>=15) THEN
     StartEarly_2H_4:=Product_Total;
     Early_2H_4_Flag:=TRUE;
 END_IF;
 
 IF (HourNow =17 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <17 AND HourNow>=17) THEN
     Early_2H_4_Flag:=FALSE;
 END_IF;
 
 IF HourNow>=15 AND HourNow<17 THEN
    Product_Early_2H_4:=Product_Total - StartEarly_2H_4;
 END_IF;
 
 // 中班产量计算（17:00-1:00） 
 // 判断是否进入中班时间（17:00:00）
 IF (HourNow =17 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <17 AND HourNow>=17) THEN // 处理跨小时的情况
     StartMiddleClassPro:=Product_Total;
     MiddleClassFlag:=TRUE;
 END_IF;
 
 // 判断是否退出中班时间（1:00:00）
 IF (HourNow =1 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast >=17) THEN // 处理跨天的情况
     MiddleClassFlag:=FALSE;
 END_IF;
 
 // 计算中班产量
 IF (HourNow>=17 AND HourNow<=23) OR (HourNow>=0 AND HourNow<1) THEN
     Product_Middle_Class:=Product_Total - StartMiddleClassPro;
 END_IF;
 
 // 中班每两小时产量计算
 // 中班第一段(17:00-19:00)
 IF (HourNow =17 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <17 AND HourNow>=17) THEN
     StartMiddle_2H_1:=Product_Total;
     Middle_2H_1_Flag:=TRUE;
 END_IF;
 
 IF (HourNow =19 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <19 AND HourNow>=19) THEN
     Middle_2H_1_Flag:=FALSE;
 END_IF;
 
 IF HourNow>=17 AND HourNow<19 THEN
    Product_Middle_2H_1:=Product_Total - StartMiddle_2H_1;
 END_IF;
 
 // 中班第二段(19:00-21:00)
 IF (HourNow =19 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <19 AND HourNow>=19) THEN
     StartMiddle_2H_2:=Product_Total;
     Middle_2H_2_Flag:=TRUE;
 END_IF;
 
 IF (HourNow =21 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <21 AND HourNow>=21) THEN
     Middle_2H_2_Flag:=FALSE;
 END_IF;
 
 IF HourNow>=19 AND HourNow<21 THEN
    Product_Middle_2H_2:=Product_Total - StartMiddle_2H_2;
 END_IF;
 
 // 中班第三段(21:00-23:00)
 IF (HourNow =21 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <21 AND HourNow>=21) THEN
     StartMiddle_2H_3:=Product_Total;
     Middle_2H_3_Flag:=TRUE;
 END_IF;
 
 IF (HourNow =23 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <23 AND HourNow>=23) THEN
     Middle_2H_3_Flag:=FALSE;
 END_IF;
 
 IF HourNow>=21 AND HourNow<23 THEN
    Product_Middle_2H_3:=Product_Total - StartMiddle_2H_3;
 END_IF;
 
 // 中班第四段(23:00-1:00)
 IF (HourNow =23 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <23 AND HourNow>=23) THEN
     StartMiddle_2H_4:=Product_Total;
     Middle_2H_4_Flag:=TRUE;
 END_IF;
 
 IF (HourNow =1 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast >=23) THEN
     Middle_2H_4_Flag:=FALSE;
 END_IF;
 
 IF (HourNow>=23 AND HourNow<=23) OR (HourNow>=0 AND HourNow<1) THEN
    Product_Middle_2H_4:=Product_Total - StartMiddle_2H_4;
 END_IF;
 
 // 晚班产量计算（1:00-9:00） 
 // 判断是否进入晚班时间（1:00:00）
 IF (HourNow =1 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast >=17) THEN // 处理跨天的情况
     StartLateClassPro:=Product_Total;
     LateClassFlag:=TRUE;
 END_IF;
 
 // 判断是否退出晚班时间（9:00:00）
 IF (HourNow =9 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <9 AND HourNow>=9) THEN // 处理跨小时的情况
     LateClassFlag:=FALSE;
 END_IF;
 
 // 计算晚班产量
 IF HourNow>=1 AND HourNow<9 THEN
     Product_Late_Class:=Product_Total - StartLateClassPro;
 END_IF;
 
 // 晚班每两小时产量计算
 // 晚班第一段(1:00-3:00)
 IF (HourNow =1 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast >=17) THEN
     StartLate_2H_1:=Product_Total;
     Late_2H_1_Flag:=TRUE;
 END_IF;
 
 IF (HourNow =3 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <3 AND HourNow>=3) THEN
     Late_2H_1_Flag:=FALSE;
 END_IF;
 
 IF HourNow>=1 AND HourNow<3 THEN
    Product_Late_2H_1:=Product_Total - StartLate_2H_1;
 END_IF;
 
 // 晚班第二段(3:00-5:00)
 IF (HourNow =3 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <3 AND HourNow>=3) THEN
     StartLate_2H_2:=Product_Total;
     Late_2H_2_Flag:=TRUE;
 END_IF;
 
 IF (HourNow =5 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <5 AND HourNow>=5) THEN
     Late_2H_2_Flag:=FALSE;
 END_IF;
 
 IF HourNow>=3 AND HourNow<5 THEN
    Product_Late_2H_2:=Product_Total - StartLate_2H_2;
 END_IF;
 
 // 晚班第三段(5:00-7:00)
 IF (HourNow =5 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <5 AND HourNow>=5) THEN
     StartLate_2H_3:=Product_Total;
     Late_2H_3_Flag:=TRUE;
 END_IF;
 
 IF (HourNow =7 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <7 AND HourNow>=7) THEN
     Late_2H_3_Flag:=FALSE;
 END_IF;
 
 IF HourNow>=5 AND HourNow<7 THEN
    Product_Late_2H_3:=Product_Total - StartLate_2H_3;
 END_IF;
 
 // 晚班第四段(7:00-9:00)
 IF (HourNow =7 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <7 AND HourNow>=7) THEN
     StartLate_2H_4:=Product_Total;
     Late_2H_4_Flag:=TRUE;
 END_IF;
 
 IF (HourNow =9 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <9 AND HourNow>=9) THEN
     Late_2H_4_Flag:=FALSE;
 END_IF;
 
 IF HourNow>=7 AND HourNow<9 THEN
    Product_Late_2H_4:=Product_Total - StartLate_2H_4;
 END_IF;
 
 // 日产量计算（9:00-次日9:00） 
 // 判断是否进入新的一天（9:00:00）
 IF (HourNow =9 AND MinuteNow=0 AND SecondNow=0) OR 
    (HourLast <9 AND HourNow>=9) THEN // 处理跨小时的情况
     StartDayClassPro:=Product_Total;
     DayFlag:=TRUE;
 END_IF;
 
 // 计算日产量
Product_Day:=Product_Total - StartDayClassPro;

// 记录昨天产量（在新的一天开始时）
IF DayFlag THEN
    // 保存昨天的产量
    Yesterday_Total := Product_Day;
    // 输出昨天的产量
    Product_Yesterday := Yesterday_Total;
    // 重置日标志
    DayFlag := FALSE;
END_IF;
 
 // 月产量计算（每月1日9:00开始） 
 // 判断是否进入新的一月（1日9:00:00）
 IF (DayNow=1 AND HourNow>=9) AND 
    (DayLast>1 OR (DayLast=1 AND HourLast<9)) THEN // 处理跨日或跨小时的情况
     StartMonthClassPro:=Product_Total;
     MonthFlag:=TRUE;
 END_IF;
 
 // 计算月产量
Product_Month:=Product_Total - StartMonthClassPro;

// 记录上月产量（在新的一月开始时）
IF MonthFlag THEN
    // 保存上月的产量
    LastMonth_Total := Product_Month;
    // 输出上月的产量
    Product_LastMonth := LastMonth_Total;
    // 重置月标志
    MonthFlag := FALSE;
END_IF;
    
 // 年产量计算（每年1月1日9:00开始） 
 // 判断是否进入新的一年（1月1日9:00:00）
 IF (MonthNow=1 AND DayNow=1 AND HourNow>=9) AND 
    ((MonthLast>1) OR (MonthLast=1 AND DayLast>1) OR (MonthLast=1 AND DayLast=1 AND HourLast<9)) THEN // 处理跨年、跨月或跨小时的情况
     StartYearClassPro:=Product_Total;
     YearFlag:=TRUE;
 END_IF;
 
 // 计算年产量
 Product_Year:=Product_Total - StartYearClassPro;
 
 // 保存当前时间作为下一次扫描的上一次时间
 YearLast:=YearNow;
 MonthLast:=MonthNow;
 DayLast:=DayNow;
 HourLast:=HourNow;
 MinuteLast:=MinuteNow;
 SecondLast:=SecondNow;
 
 END_FUNCTION_BLOCK